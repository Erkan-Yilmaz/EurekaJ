// ==========================================================================
// Project:   SproutCore - JavaScript Application Framework
// Copyright: ©2006-2011 Strobe Inc. and contributors.
//            Portions ©2008-2011 Apple Inc. All rights reserved.
// License:   Licensed under MIT license (see license.js)
// ==========================================================================

(function(a){function g(a){if(a.length<1e3)return a.slice();var b=0,c=[],d=a[0];while(d!==0)c[b]=d,b=d<0?0-d:d,d=a[b];c[b]=0,f(this,0,b,c);return c}function f(a,b,c,e){e===undefined&&(e=a._content);var f=SC.IndexSet.HINT_SIZE,g=d(e[b]),h=b-b%f+f,i=b+c;while(h<i){while(g!==0&&g<=h)b=g,g=d(e[b]);g===0?delete e[h]:h!==b&&(e[h]=b),h+=f}}function e(a){return a instanceof SC.IndexSet}var b=SC.get,c=SC.set,d=Math.abs;SC.IndexSet=SC.Object.extend(SC.Enumerable,SC.MutableEnumerable,SC.Freezable,SC.Copyable,{isIndexSet:YES,length:0,max:0,min:function(){var a=this._content,b=a[0];return b===0?-1:b>0?0:d(b)}.property("[]").cacheable(),init:function(a,d){this._super(),a&&e(a)?(this._content=g(a._content),c(this,"max",b(a,"max")),c(this,"length",b(a,"length")),c(this,"source",b(a,"source"))):(this._content=[0],a!==undefined&&this.add(a,d))},firstObject:function(){return b(this,"length")>0?b(this,"min"):undefined}.property(),rangeStartForIndex:function(a){var c=this._content,e=b(this,"max"),f,g,h;if(a>=e)return e;if(d(c[a])>a)return a;h=a-a%SC.IndexSet.HINT_SIZE,f=c[h];if(f<0||f>a)f=h;g=d(c[f]);while(g<a)f=g,g=d(c[f]);return f},isEqual:function(a){if(a===this)return YES;if(!a||!e(a)||b(a,"max")!==b(this,"max")||b(a,"length")!==b(this,"length"))return NO;var c=this._content,f=a._content,g=0,h=c[g];do{if(f[g]!==h)return NO;g=d(h),h=c[g]}while(g!==0);return YES},indexBefore:function(a){if(a===0)return-1;a--;var c=this._content,d=b(this,"max"),e=this.rangeStartForIndex(a);if(!c)return null;while(e===d||c[e]<0){if(e===0)return-1;a=e-1,e=this.rangeStartForIndex(a)}return a},indexAfter:function(a){var c=this._content,e=b(this,"max"),f,g;if(!c||a>=e)return-1;a++,f=this.rangeStartForIndex(a),g=c[f];while(g<0){if(g===0)return-1;a=f=d(g),g=c[f]}return a},contains:function(a,b){var c,f,g,h,i;if(b===undefined){if(a===null||a===undefined)return NO;if("number"==typeof a)b=1;else{if(a&&e(a)){if(a===this)return YES;c=a._content,f=0,g=c[f];while(g!==0){if(g>0&&!this.contains(f,g-f))return NO;f=d(g),g=c[f]}return YES}b=a.length,a=a.start}}h=this.rangeStartForIndex(a),i=this._content[h];return i>0&&h<=a&&i>=a+b},intersects:function(a,b){var c,f,g,h;if(b===undefined)if("number"==typeof a)b=1;else{if(a&&e(a)){if(a===this)return YES;c=a._content,f=0,g=c[f];while(g!==0){if(g>0&&this.intersects(f,g-f))return YES;f=d(g),g=c[f]}return NO}b=a.length,a=a.start}f=this.rangeStartForIndex(a),c=this._content,g=c[f],h=a+b;while(f<h){if(g===0)return NO;if(g>0&&g>a)return YES;f=d(g),g=c[f]}return NO},without:function(a,b){if(a===this)return new SC.IndexSet;return this.copy().remove(a,b)},replace:function(a,d){if(d===undefined)if("number"==typeof a)d=1;else{if(a&&e(a)){var f=b(this,"length"),h=b(a,"length");this.enumerableContentWillChange(f,h),SC.beginPropertyChanges(this),this._content=g(a._content),c(this,"max",b(a,"max")),c(this,"length",h),c(this,"source",b(a,"source")),SC.endPropertyChanges(this),this.enumerableContentDidChange(f,h);return this}d=a.length,a=a.start}var i=this.length;this._content.length=1,this._content[0]=0,this.length=this.max=0;return this.add(a,d)},add:function(a,g){if(b(this,"isFrozen"))throw new Error(SC.FROZEN_ERROR);var h,i,j,k;if(a&&e(a)){a.forEachRange(this.add,this);return this}if(g===undefined){if(a===null||a===undefined)return this;"number"==typeof a?g=1:(g=a.length,a=a.start)}else g===null&&(g=1);if(!(g>0))return this;var l=b(this,"max"),m=l,n,o;h=this._content;if(a===l)this.enumerableContentWillChange(),k=!0,a>0?(i=this.rangeStartForIndex(a-1),j=h[i],j>0?(delete h[l],h[i]=l=a+g,a=i):h[l]=l=a+g):h[a]=l=g,h[l]=0,c(this,"max",l),c(this,"length",b(this,"length")+g),g=l-a;else if(a>l)this.enumerableContentWillChange(),k=!0,h[l]=0-a,h[a]=a+g,h[a+g]=0,c(this,"max",a+g),c(this,"length",this.length+g),g=a+g-l,a=l;else{i=this.rangeStartForIndex(a),j=h[i],l=a+g,n=0,a>0&&i===a&&j<=0&&(i=this.rangeStartForIndex(a-1),j=h[i]),j<0?(h[i]=0-a,d(j)>l?(h[a]=0-l,h[l]=j):h[a]=j):(a=i,j>l&&(l=j)),i=a;while(i<l)o=h[i],o===0?(h[l]=0,j=l,n+=l-i,!k&&n>0&&(this.enumerableContentWillChange(),k=!0)):(j=d(o),j>l&&(h[l]=o,j=l),o<0&&(n+=j-i,!k&&n>0&&(this.enumerableContentWillChange(),k=!0))),delete h[i],i=j;(i=h[l])>0&&(delete h[l],l=i),h[a]=l,l>m&&c(this,"max",l),c(this,"length",b(this,"length")+n),g=l-a}f(this,a,g),k&&this.enumerableContentDidChange();return this},remove:function(a,g){if(b(this,"isFrozen"))throw new Error(SC.FROZEN_ERROR);if(g===undefined){if(a===null||a===undefined)return this;if("number"==typeof a)g=1;else{if(e(a)){a.forEachRange(this.remove,this);return this}g=a.length,a=a.start}}if(!(g>0))return this;this.enumerableContentWillChange();var h=b(this,"max"),i=h,j=this._content,k,l,m,n,o;if(a>=h)return this;k=this.rangeStartForIndex(a),l=j[k],o=a+g,m=0,a>0&&k===a&&l>0&&(k=this.rangeStartForIndex(a-1),l=j[k]),l>0?(j[k]=a,l>o?(j[a]=o,j[o]=l):j[a]=l):(a=k,l=d(l),l>o&&(o=l)),k=a;while(k<o)n=j[k],n===0?(j[o]=0,l=o):(l=d(n),l>o&&(j[o]=n,l=o),n>0&&(m+=l-k)),delete j[k],k=l;(k=j[o])<0&&(delete j[o],o=d(k)),j[o]===0?(delete j[o],j[a]=0,c(this,"max",a)):j[a]=0-o,c(this,"length",b(this,"length")-m),g=o-a,f(this,a,g),this.enumerableContentDidChange();return this},clear:function(){if(b(this,"isFrozen"))throw new Error(SC.FROZEN_ERROR);var a=b(this,"length");a>0&&this.enumerableContentWillChange(),SC.beginPropertyChanges(this),this._content.length=1,this._content[0]=0,c(this,"length",0),c(this,"max",0),SC.endPropertyChanges(this),a>0&&this.enumerableContentDidChange()},addEach:function(a){if(b(this,"isFrozen"))throw new Error(SC.FROZEN_ERROR);SC.beginPropertyChanges(this),a.forEach(function(a){this.add(a)},this),SC.endPropertyChanges(this);return this},removeEach:function(a){if(b(this,"isFrozen"))throw new Error(SC.FROZEN_ERROR);SC.beginPropertyChanges(this),a.forEach(function(a){this.remove(a)},this),SC.endPropertyChanges(this);return this},copy:function(){return new SC.IndexSet(this)},clone:SC.alias("copy"),slice:SC.alias("copy"),inspect:function(){var a=this._content,b=a.length,c=0,d=[],e;for(c=0;c<b;c++)e=a[c],e!==undefined&&d.push("%@:%@".fmt(c,e));return"SC.IndexSet<%@>".fmt(d.join(" , "))},forEachRange:function(a,b){var c=this._content,e=0,f=c[e],g=this.source;b===undefined&&(b=null);while(f!==0)f>0&&a.call(b,e,f-e,this,g),e=d(f),f=c[e];return this},forEachIn:function(a,b,c,e){var f=this._content,g=0,h=0,i=a+b,j=this.source,k=f[g];e===undefined&&(e=null);while(k!==0){g<a&&(g=a);while(g<k&&g<i)c.call(e,g++,h++,this,j);g>=i?g=k=0:(g=d(k),k=f[g])}return this},lengthIn:function(a,c){var f=0;if(c===undefined){if(a===null||a===undefined)return 0;if("number"==typeof a)c=1;else{if(e(a)){a.forEachRange(function(a,b){f+=this.lengthIn(a,b)},this);return f}c=a.length,a=a.start}}if(b(this,"length")===0)return 0;var g=this._content,h=0,i=g[h],j=a+c;while(h<j&&i!==0)i>0&&(f+=i>j?j-h:i-h),h=d(i),i=g[h];return f},source:null,indexOf:function(a,c){var e=b(this,"source");if(!e)throw"%@.indexOf() requires source".fmt(this);var f=b(e,"length"),g=this._content,h=g[0]<0?d(g[0]):0,i;while(h>=0&&h<f){i=e.indexOf(a,h);if(i<0)return-1;if(this.contains(i))return i;h=i+1}return-1},lastIndexOf:function(a,c){var d=b(this,"source");if(!d)throw"%@.lastIndexOf() requires source".fmt(this);var e=b(d,"length"),f=b(this,"max")-1,g;f>=e&&(f=e-1);while(f>=0){g=d.lastIndexOf(a,f);if(g<0)return-1;if(this.contains(g))return g;f=g+1}return-1},forEachObject:function(a,c){var e=b(this,"source");if(!e)throw"%@.forEachObject() requires source".fmt(this);var f=this._content,g=0,h=0,i=f[g];c===undefined&&(c=null);while(i!==0){while(g<i)a.call(c,e.objectAt(g),g,e,this),g++;g=d(i),i=f[g]}return this},addObject:function(a,c){var d=b(this,"source");sc_assert("%@.addObject() requires source".fmt(this),!!d);var e=b(d,"length"),f=0,g;while(f>=0&&f<e){g=d.indexOf(a,f);if(!(g>=0))return this;this.add(g);if(c)return this;f=g++}return this},addObjects:function(a,b){a.forEach(function(a){this.addObject(a,b)},this);return this},removeObject:function(a,c){var d=b(this,"source");sc_assert("%@.removeObject() requires source".fmt(this),!!d);var e=d.get("length"),f=0,g;while(f>=0&&f<e){g=d.indexOf(a,f);if(!(g>=0))return this;this.remove(g);if(c)return this;f=g+1}return this},removeObjects:function(a,b){a.forEach(function(a){this.removeObject(a,b)},this);return this},LOG_OBSERVING:NO,forEach:function(a,c){var e=this._content,f=0,g=0,h=b(this,"source"),i=e[f];c===undefined&&(c=null);while(i!==0){while(f<i)a.call(c,f++,g++,this,h);f=d(i),i=e[f]}return this},nextObject:function(a,c,e){var f=this._content,g=e.next,h=b(this,"max");if(c===null)c=g=0;else{if(c>=h){delete e.next;return null}c++}if(c===g){do c=d(g),g=f[c];while(g<0);e.next=g}return c},toString:function(){var a=[];this.forEachRange(function(b,c){a.push(c===1?b:"%@..%@".fmt(b,b+c-1))},this);return"SC.IndexSet<%@>".fmt(a.join(","))}}),SC.IndexSet.reopenClass({create:function(a,b){if("number"==typeof a||e(a)){var c=this;return new c(a,b)}return this._super.apply(this,arguments)},HINT_SIZE:256,EMPTY:(new SC.IndexSet).freeze()})})({}),function(a){}({}),function(a){var b=SC.get,c=SC.set,d=SC.getPath;SC.Query=SC.Object.extend(SC.Copyable,SC.Freezable,{isQuery:YES,conditions:null,orderBy:null,recordType:null,recordTypes:null,expandedRecordTypes:function(){var a=SC.Set.create(),c,d;(c=b(this,"recordType"))?this._scq_expandRecordType(c,a):(c=b(this,"recordTypes"))?c.forEach(function(b){this._scq_expandRecordType(b,a)},this):this._scq_expandRecordType(SC.Record,a),d=SC.Query._scq_queriesWithExpandedRecordTypes,d||(d=SC.Query._scq_queriesWithExpandedRecordTypes=SC.Set.create()),d.add(this);return a.freeze()}.property("recordType","recordTypes").cacheable(),_scq_expandRecordType:function(a,b){b.contains(a)||(b.add(a),SC.typeOf(a)==="string"&&(a=d(a)),a.subclasses.forEach(function(a){this._scq_expandRecordType(a,b)},this))},parameters:null,location:"local",scope:null,isRemote:function(){return b(this,"location")===SC.Query.REMOTE}.property("location").cacheable(),isLocal:function(){return b(this,"location")===SC.Query.LOCAL}.property("location").cacheable(),isEditable:NO,contains:function(a,c){var d,e=YES;if(d=b(this,"recordTypes"))e=d.find(function(b){return a instanceof b});else if(d=b(this,"recordType"))e=a instanceof d;if(!e)return NO;var f=b(this,"scope");if(f&&!f.contains(a))return NO;this._isReady||this.parse();if(!this._isReady)return NO;c===undefined&&(c=this.parameters||this);return this._tokenTree.evaluate(a,c)},containsRecordTypes:function(a){var c=b(this,"recordType");return c?!!a.find(function(a){return c.detect(a)}):(c=b(this,"recordTypes"))?!!c.find(function(b){return!!a.find(function(a){return b.detect(a)})}):YES},compare:function(a,c){var d=0,e,f,g,h;if(a===c)return 0;this._isReady||this.parse();if(!this._isReady)return SC.compare(b(a,"id"),b(c,"id"));f=this._order;if(SC.typeOf(f)==="function")d=f.call(null,a,c);else{g=f?f.length:0;for(h=0;d===0&&h<g;h++)e=f[h].propertyName,SC.Query.comparisons[e]?d=SC.Query.comparisons[e](b(a,e),b(c,e)):d=SC.compare(b(a,e),b(c,e)),d!==0&&f[h].descending&&(d=-1*d)}return d!==0?d:SC.compare(b(a,"id"),b(c,"id"))},_isReady:NO,parse:function(){var a=b(this,"conditions"),c=b(this,"queryLanguage"),d,e;d=this._tokenList=this.tokenizeString(a,c),e=this._tokenTree=this.buildTokenTree(d,c),this._order=this.buildOrder(b(this,"orderBy")),this._isReady=!!e&&!e.error;if(e&&e.error)throw e.error;return this._isReady},queryWithScope:function(a){var b="__query__"+SC.guidFor(this),d=a[b];d||(a[b]=d=this.copy(),c(d,"scope",a),d.freeze());return d},copyKeys:["conditions","orderBy","recordType","recordTypes","parameters","location","scope"],concatenatedProperties:["copyKeys"],copy:function(){var a={},c=b(this,"copyKeys"),d=c?c.length:0,e,f,g;while(--d>=0)e=c[d],f=b(this,e),f!==undefined&&(a[e]=f);g=this.constructor.create(a),a=null;return g},queryLanguage:{UNKNOWN:{firstCharacter:/[^\s'"\w\d\(\)\{\}]/,notAllowed:/[\-\s'"\w\d\(\)\{\}]/},PROPERTY:{firstCharacter:/[a-zA-Z_]/,notAllowed:/[^a-zA-Z_0-9\.]/,evalType:"PRIMITIVE",evaluate:function(a,b){return SC.getPath(a,this.tokenValue)}},NUMBER:{firstCharacter:/[\d\-]/,notAllowed:/[^\d\-\.]/,format:/^-?\d+$|^-?\d+\.\d+$/,evalType:"PRIMITIVE",evaluate:function(a,b){return parseFloat(this.tokenValue)}},STRING:{firstCharacter:/['"]/,delimeted:!0,evalType:"PRIMITIVE",evaluate:function(a,b){return this.tokenValue}},PARAMETER:{firstCharacter:/\{/,lastCharacter:"}",delimeted:!0,evalType:"PRIMITIVE",evaluate:function(a,b){return b[this.tokenValue]}},"%@":{rememberCount:!0,reservedWord:!0,evalType:"PRIMITIVE",evaluate:function(a,b){return b[this.tokenValue]}},OPEN_PAREN:{firstCharacter:/\(/,singleCharacter:!0},CLOSE_PAREN:{firstCharacter:/\)/,singleCharacter:!0},AND:{reservedWord:!0,leftType:"BOOLEAN",rightType:"BOOLEAN",evalType:"BOOLEAN",evaluate:function(a,b){var c=this.leftSide.evaluate(a,b),d=this.rightSide.evaluate(a,b);return c&&d}},OR:{reservedWord:!0,leftType:"BOOLEAN",rightType:"BOOLEAN",evalType:"BOOLEAN",evaluate:function(a,b){var c=this.leftSide.evaluate(a,b),d=this.rightSide.evaluate(a,b);return c||d}},NOT:{reservedWord:!0,rightType:"BOOLEAN",evalType:"BOOLEAN",evaluate:function(a,b){var c=this.rightSide.evaluate(a,b);return!c}},"=":{reservedWord:!0,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(a,b){var c=this.leftSide.evaluate(a,b),d=this.rightSide.evaluate(a,b);return SC.isEqual(c,d)}},"!=":{reservedWord:!0,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(a,b){var c=this.leftSide.evaluate(a,b),d=this.rightSide.evaluate(a,b);return!SC.isEqual(c,d)}},"<":{reservedWord:!0,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(a,b){var c=this.leftSide.evaluate(a,b),d=this.rightSide.evaluate(a,b);return SC.compare(c,d)==-1}},"<=":{reservedWord:!0,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(a,b){var c=this.leftSide.evaluate(a,b),d=this.rightSide.evaluate(a,b);return SC.compare(c,d)!=1}},">":{reservedWord:!0,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(a,b){var c=this.leftSide.evaluate(a,b),d=this.rightSide.evaluate(a,b);return SC.compare(c,d)==1}},">=":{reservedWord:!0,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(a,b){var c=this.leftSide.evaluate(a,b),d=this.rightSide.evaluate(a,b);return SC.compare(c,d)!=-1}},BEGINS_WITH:{reservedWord:!0,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(a,b){var c=this.leftSide.evaluate(a,b),d=this.rightSide.evaluate(a,b);return c&&c.indexOf(d)===0}},ENDS_WITH:{reservedWord:!0,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(a,b){var c=this.leftSide.evaluate(a,b),d=this.rightSide.evaluate(a,b);return c&&c.indexOf(d)===c.length-d.length}},CONTAINS:{reservedWord:!0,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(a,b){var c=this.leftSide.evaluate(a,b)||[],d=this.rightSide.evaluate(a,b),e=SC.typeOf(c);if(e==="string")return c.indexOf(d)!==-1;if(e==="array"||c.toArray){e!=="array"&&(c=c.toArray());var f=!1,g=0;while(f===!1&&g<c.length)d==c[g]&&(f=!0),g++;return f}}},ANY:{reservedWord:!0,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(a,b){var c=this.leftSide.evaluate(a,b),d=this.rightSide.evaluate(a,b),e=!1,f=0;while(e===!1&&f<d.length)c==d[f]&&(e=!0),f++;return e}},MATCHES:{reservedWord:!0,leftType:"PRIMITIVE",rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(a,b){var c=this.leftSide.evaluate(a,b),d=this.rightSide.evaluate(a,b);return d.test(c)}},TYPE_IS:{reservedWord:!0,rightType:"PRIMITIVE",evalType:"BOOLEAN",evaluate:function(a,b){var c=SC.Store.recordTypeFor(a.storeKey),e=this.rightSide.evaluate(a,b),f=d(e);return c==f}},"null":{reservedWord:!0,evalType:"PRIMITIVE",evaluate:function(a,b){return null}},"undefined":{reservedWord:!0,evalType:"PRIMITIVE",evaluate:function(a,b){return undefined}},"false":{reservedWord:!0,evalType:"PRIMITIVE",evaluate:function(a,b){return!1}},"true":{reservedWord:!0,evalType:"PRIMITIVE",evaluate:function(a,b){return!0}},YES:{reservedWord:!0,evalType:"PRIMITIVE",evaluate:function(a,b){return!0}},NO:{reservedWord:!0,evalType:"PRIMITIVE",evaluate:function(a,b){return!1}}},tokenizeString:function(a,b){function q(a,d){e=b[a],e.format&&!e.format.test(d)&&(a="UNKNOWN"),e.delimeted&&(o=!0);if(!e.delimeted)for(var f in b)b[f].reservedWord&&f==d&&(a=f);e=b[a],e&&e.rememberCount&&(p[a]||(p[a]=0),d=p[a],p[a]+=1),c.push({tokenType:a,tokenValue:d}),h=null,i=null,j=null}var c=[],d=null,e=null,f=null,g=null,h=null,i=null,j=null,k=null,l=!1,m=!1,n=!1,o=!1,p={};if(!a)return[];var r=a.length;for(var s=0;s<r;s++){l=s===r-1,d=a.charAt(s),o=!1,h&&(e=b[h],m=e.delimeted?d===k:e.notAllowed.test(d),m||(j+=d),(m||l)&&q(h,j),l&&!m&&(o=!0));if(!h&&!o){for(f in b)e=b[f],e.firstCharacter&&e.firstCharacter.test(d)&&(h=f);h&&(e=b[h],j=d,e.delimeted&&(j="",e.lastCharacter?k=e.lastCharacter:k=d),(e.singleCharacter||l)&&q(h,j))}}return c},buildTokenTree:function(a,b){function s(a){k(a),k(e.pop())}function r(a){var b=a;if(b<1)return!1;c[b-1].rightSide=c[b],k(b)}function q(a){var b=a;if(b<1)return!1;c[b].leftSide=c[b-1],k(b-1)}function p(a){var b=a;if(m(b))return!1;if(!l(b))return!1;if(!m(b-1))return!1;return n(b-1,b)?!0:!1}function o(a){var b=a;if(!m(b))return!1;if(!l(b))return!1;return n(b,b-1)?!0:!1}function n(a,b){var c=b<a?"left":"right";if(a<0||b<0)return!1;if(!i(c,a))return!1;if(!j(b))return!1;return i(c,a)==j(b)?!0:!1}function m(a){var b=a;if(b<0)return!0;return i("left",b)&&!c[b].leftSide||i("right",b)&&!c[b].rightSide}function l(a){var b=a||d;return b>0?!0:!1}function k(a){c.splice(a,1),a<=d&&d--}function j(a){var b=a,c=h(b);return c?c.evalType:!1}function i(a,b){var c=b,d=h(c);if(!d)return!1;if(a=="left")return d.leftType;if(a=="right")return d.rightType}function h(a){var d=a;if(d<0)return!1;var e=b[c[d].tokenType];if(!e){g.push("logic for token '"+c[d].tokenType+"' is not defined");return!1}c[d].evaluate=e.evaluate;return e}var c=a.slice(),d=0,e=[],f=!1,g=[];if(!a||a.length===0)return{evaluate:function(){return!0}};for(d=0;d<c.length;d++)f=!1,c[d].tokenType=="UNKNOWN"&&g.push("found unknown token: "+c[d].tokenValue),c[d].tokenType=="OPEN_PAREN"&&e.push(d),c[d].tokenType=="CLOSE_PAREN"&&s(d),o(d)&&q(d),p(d)&&(r(d),f=!0),f&&d--;c.length==1?c=c[0]:g.push("string did not resolve to a single tree");return g.length>0?{error:g.join(",\n"),tree:c}:c},buildOrder:function(a){if(!a)return[];if(SC.typeOf(a)==="function")return a;var b=a.split(",");for(var c=0;c<b.length;c++){var d=b[c];d=d.replace(/^\s+|\s+$/,""),d=d.replace(/\s+/,","),d=d.split(","),b[c]={propertyName:d[0]},d[1]&&d[1]=="DESC"&&(b[c].descending=!0)}return b}}),SC.Query.reopenClass({LOCAL:"local",REMOTE:"remote",storeKeyFor:function(a){return a?b(a,"storeKey"):null},containsRecords:function(a,c,d){var e=[];for(var f=0,g=b(c,"length");f<g;f++){var h=c.objectAt(f);h&&a.contains(h)&&e.push(b(h,"storeKey"))}e=SC.Query.orderStoreKeys(e,a,d);return e},orderStoreKeys:function(a,b,c){if(a)var d=a.sort(function(a,d){return SC.Query.compareStoreKeys(b,c,a,d)});return a},compareStoreKeys:function(a,b,c,d){var e=b.materializeRecord(c),f=b.materializeRecord(d);return a.compare(e,f)},build:function(a,e,f,g){var h=null,i,j,k,l;if(e&&e.isQuery){if(b(e,"location")===a)return e;i=e.copy(),c(i,"location",a);return i.freeze()}if(typeof e=="string"){i=d(e);if(!i)throw"%@ did not resolve to a class".fmt(e);e=i}else e&&e.isEnumerable?(i=[],e.forEach(function(a){typeof a=="string"&&(a=d(a));if(!a)throw"cannot resolve record types: %@".fmt(e);i.push(a)},this),e=i):e||(e=SC.Record);g===undefined&&(g=null),f===undefined&&(f=null),!g&&typeof f!="string"&&(h=f,f=null),!g&&!h?(l=SC.Query._scq_recordTypeCache,l||(l=SC.Query._scq_recordTypeCache={}),j=l[a],j||(j=l[a]={}),e.isEnumerable?(k=e.map(function(a){return SC.guidFor(a)}),k=k.sort().join(":")):k=SC.guidFor(e),f&&(k=[k,f].join("::")),i=j[k],i||(e.isEnumerable?h={recordTypes:e.copy()}:h={recordType:e},h.location=a,h.conditions=f,i=j[k]=SC.Query.create(h).freeze())):(h||(h={}),h.location||(h.location=a),e&&e.isEnumerable?h.recordsTypes=e:h.recordType=e,f&&(h.conditions=f),g&&(h.parameters=g),i=SC.Query.create(h).freeze());return i},local:function(a,b,c){return this.build(SC.Query.LOCAL,a,b,c)},remote:function(a,b,c){return this.build(SC.Query.REMOTE,a,b,c)},_scq_didDefineRecordType:function(){var a=SC.Query._scq_queriesWithExpandedRecordTypes;a&&(a.forEach(function(a){SC.propertyWillChange(a,"expandedRecordTypes"),SC.propertyDidChange(a,"expandedRecordTypes")},this),a.clear())}}),SC.Query.comparisons={},SC.Query.registerComparison=function(a,b){SC.Query.comparisons[a]=b},SC.Query.registerQueryExtension=function(a,c){b(SC.Query,"proto").queryLanguage[a]=c}}({}),function(a){var b=SC.get,c=SC.set;SC.StoreError=SC.Object.extend({code:-1,message:"",errorValue:null,errorObject:function(){return this}.property().cacheable(),label:null,toString:function(){return"SC.StoreError:%@:%@ (%@)".fmt(SC.guidFor(this),b(this,"message"),b(this,"code"))},isError:YES}),SC.StoreError.desc=function(a,b,c,d){var e={message:a};b!==undefined&&(e.label=b),d!==undefined&&(e.code=d),c!==undefined&&(e.errorValue=c);return this.create(e)},SC.$error=function(a,b,c,d){return SC.StoreError.desc(a,b,c,d)},SC.ok=function(a){return a!==!1&&(!a||!a.isError)},SC.$ok=SC.ok,SC.val=function(a){return a&&a.isError?b(a,"errorValue"):a},SC.$val=SC.val,SC.StoreError.HAS_MULTIPLE_VALUES=-100}({}),function(a){var b=SC.get,c=SC.set,d=SC.none,e=SC.copy,f;SC.Record=SC.Object.extend({isRecord:YES,isParentRecord:NO,primaryKey:"guid",id:function(a,c){if(c!==undefined){this.writeAttribute(b(this,"primaryKey"),c);return c}return SC.Store.idFor(b(this,"storeKey"))}.property("storeKey").cacheable(),status:function(){return this.store.readStatus(b(this,"storeKey"))}.property("storeKey").cacheable(),store:null,storeKey:null,isDestroyed:function(){return!!(b(this,"status")&SC.Record.DESTROYED)}.property("status").cacheable(),isEditable:function(a,c){c!==undefined&&(this._screc_isEditable=c);return b(this,"status")&SC.Record.READY&&this._screc_isEditable}.property("status").cacheable(),_screc_isEditable:YES,isLoaded:function(){var a=b(this,"status");return a!==f.EMPTY&&a!==f.BUSY_LOADING&&a!==f.ERROR}.property("status").cacheable(),relationships:null,attributes:function(){return b(this,"store").readEditableDataHash(b(this,"storeKey"))}.property(),readOnlyAttributes:function(){var a=b(this,"store").readDataHash(b(this,"storeKey"));return a?e(a):null}.property(),nestedRecordNamespace:null,isNestedRecord:function(){var a=b(this,"store"),c=b(this,"storeKey");return!!a.parentStoreKeyExists(c)}.property("storeKey").cacheable(),parentRecord:function(){var a=b(this,"storeKey"),c=b(this,"store");return c.materializeParentRecord(a)}.property("storeKey").cacheable(),refresh:function(a,c){var e=b(this,"store"),f,g,h=b(this,"storeKey"),i=e.parentStoreKeyExists();!c&&"function"==typeof a&&(c=a,a=!1),a||d(a)&&d(i)?e.refreshRecord(null,null,h,c):i&&(f=e.materializeRecord(i),f.refresh(!1,c));return this},destroy:function(a){var c=b(this,"store"),e,f,g=b(this,"storeKey"),h=c.parentStoreKeyExists();f=a||d(a)&&d(h),f?(SC.propertyWillChange(this,"status"),c.destroyRecord(null,null,g),SC.propertyDidChange(this,"status"),this.propagateToAggregates()):h&&(e=c.materializeRecord(h),e.destroy(!1));return this},recordDidChange:function(a){var c=b(this,"parentRecord");c&&c.recordDidChange(),b(this,"store").recordDidChange(null,null,b(this,"storeKey"),a),this.notifyPropertyChange("status"),this.propagateToAggregates();return this},_editLevel:0,beginEditing:function(){this._editLevel++;return this},endEditing:function(a){--this._editLevel<=0&&(this._editLevel=0,this.recordDidChange(a));return this},readAttribute:function(a){var c=b(this,"store"),d=b(this,"storeKey"),e=c.readDataHash(d);return e?e[a]:undefined},writeAttribute:function(a,c,d){var e=b(this,"store"),g=b(this,"storeKey"),h;h=e.readEditableDataHash(g);if(!h)throw f.BAD_STATE_ERROR;c!==h[a]&&(d||this.beginEditing(),h[a]=c,a===b(this,"primaryKey")&&(SC.propertyWillChange(this,"id"),SC.Store.replaceIdFor(g,c),SC.propertyDidChange(this,"id")),d||this.endEditing(a));return this},propagateToAggregates:function(){var a=b(this,"storeKey"),c=SC.Store.recordTypeFor(a),d,e,f,g,h,i;i=c.aggregates;if(!i){var j=b(this,"store").readDataHash(a),k=SC.RecordAttribute.attrFor,l;i=[];for(var m in j)l=k(this,m),l&&b(l,"aggregate")&&i.push(m);c.aggregates=i}var n=SC.Record,o=n.DIRTY,p=n.READY_NEW,q=n.DESTROYED,r=n.READY_CLEAN,s;s=function(a){var c,d;if(a){c=b(this,"status");if(c&o||c&p||c&q)d=b(a,"status"),d===r&&b(a,"store").recordDidChange(b(a,"constructor"),null,b(a,"storeKey"),null,YES)}};for(d=0,e=i.length;d<e;++d)f=i[d],g=b(this,f),h=g instanceof SC.ManyArray?g:[g],h.forEach(s,this)},notifyPropertyChange:function(a){SC.propertyWillChange(this,a),SC.propertyDidChange(this,a)},storeDidChangeProperties:function(a,c){if(a)this.notifyPropertyChange("status");else{c||(c=b(this,"store").readDataHash(b(this,"storeKey")),c&&(c=SC.keys(c))),SC.beginPropertyChanges(this),c&&c.forEach(function(a){this.notifyPropertyChange(a)},this),this.notifyPropertyChange("status"),SC.endPropertyChanges(this);var d=this.relationships,e=d?d.length:0;while(--e>=0)d[e].recordPropertyDidChange(c)}},normalize:function(a){var c=this.primaryKey,d=b(this,"id"),e=b(this,"store"),f=b(this,"storeKey"),g,h,i,j,k,l,m,n,o,p,q=e.readEditableDataHash(f)||{};q[c]=d,i=e.readDataHash(f);var r=SC.RecordAttribute.attrFor;for(g in this){p=r(this,g);if(p){o=b(p,"key")||g,h=b(p,"typeClass"),l=SC.typeOf(b(p,"typeClass"))==="class",m=b(p,"isNestedRecordTransform");if(l)j=i[o],j!==undefined?q[o]=j:(n=b(p,"defaultValue"),"function"==typeof n?q[o]=n(this,g,n):q[o]=n);else if(m)j=b(this,g),j&&j.normalize&&j.normalize();else{j=b(this,g);if(j!==undefined||j===null&&a)j=p.fromType(this,g,j),q[o]=j}}}return this},setUnknownProperty:function(a,c){if(this[a]===undefined){var d=b(this,"storeKey"),e=SC.Store.recordTypeFor(d);if(e.ignoreUnknownProperties===YES){this[a]=c;return c}var f=b(this,"primaryKey");this.writeAttribute(a,c),a===f&&SC.Store.replaceIdFor(d,c);return this.unknownProperty(a)}return this._super(a,c)},unknownProperty:function(a){return this.readAttribute(a)},commitRecord:function(a,c,d){var e=b(this,"store"),f,g,h=b(this,"storeKey"),i=e.parentStoreKeyExists();g=c||SC.none(c)&&SC.none(i),g?e.commitRecord(undefined,undefined,b(this,"storeKey"),a,d):i&&(f=e.materializeRecord(i),f.commitRecord(a,c,d));return this},isError:function(){return b(this,"status")&SC.Record.ERROR}.property("status").cacheable(),errorValue:function(){return b(this,"isError")?SC.val(b(this,"errorObject")):null}.property("isError").cacheable(),errorObject:function(){if(b(this,"isError")){var a=b(this,"store");return a.readError(b(this,"storeKey"))||f.GENERIC_ERROR}return null}.property("isError").cacheable(),set:function(a,c){var d=this[a];if(d&&d.isProperty&&!b(d,"isEditable"))return this;return this._super(a,c)},toString:function(){var a=b(this,"store").readDataHash(b(this,"storeKey"));return"%@(%@) %@".fmt(this.constructor.toString(),SC.inspect(a),this.statusString())},statusString:function(){var a=[],c=b(this,"status");for(var d in SC.Record)d.match(/[A-Z_]$/)&&SC.Record[d]===c&&a.push(d);return a.join(" ")},registerNestedRecord:function(a,d,e){var f,g,h,i,j;SC.none(e)&&(e=d),a instanceof SC.Record?i=a:(j=this._materializeNestedRecordType(a,d),i=this.createNestedRecord(j,a)),i&&(c(this,"isParentRecord",YES),f=b(this,"store"),g=b(this,"storeKey"),h=b(i,"storeKey"),f.registerChildToParent(g,h,e));return i},_materializeNestedRecordType:function(a,c){var d,e,f,g,h;h=SC.typeOf(a);if(h==="instance"||h==="object")d=b(this,"nestedRecordNamespace"),b(a,"type")&&!SC.none(d)&&(e=b(d,b(a,"type")));!e&&c&&(g=SC.RecordAttribute.attrFor(this,c),g&&(e=b(g,"typeClass")));if(!SC.Record.detect(e))throw"SC.Child: Error during transform: Invalid record type.";return e},createNestedRecord:function(a,c){var d,e,f,g,h=null,i=null;SC.run(this,function(){c=c||{},i=c[b(a,"proto").primaryKey],d=b(this,"store");if(SC.none(d))throw"Error: during the creation of a child record: NO STORE ON PARENT!";!e&&(g=b(a,"proto").primaryKey)&&(e=c[g],f=e?d.storeKeyExists(a,e):null,f?(d.writeDataHash(f,c),h=d.materializeRecord(f)):(h=d.createRecord(a,c),SC.none(e)&&(f=b(h,"storeKey"),e="cr"+f,SC.Store.replaceIdFor(f,e),c=d.readEditableDataHash(f),c[g]=e))),SC.none(i)&&this.generateIdForChild&&this.generateIdForChild(h)});return h},_nestedRecordKey:0,generateIdForChild:function(a){}}),SC.Record.reopenClass({ignoreUnknownProperties:NO,CLEAN:1,DIRTY:2,EMPTY:256,ERROR:4096,READY:512,READY_CLEAN:513,READY_DIRTY:514,READY_NEW:515,DESTROYED:1024,DESTROYED_CLEAN:1025,DESTROYED_DIRTY:1026,BUSY:2048,BUSY_LOADING:2052,BUSY_CREATING:2056,BUSY_COMMITTING:2064,BUSY_REFRESH:2080,BUSY_REFRESH_CLEAN:2081,BUSY_REFRESH_DIRTY:2082,BUSY_DESTROYING:2112,BAD_STATE_ERROR:SC.$error("Internal Inconsistency"),RECORD_EXISTS_ERROR:SC.$error("Record Exists"),NOT_FOUND_ERROR:SC.$error("Not found "),BUSY_ERROR:SC.$error("Busy"),GENERIC_ERROR:SC.$error("Generic Error"),_nextChildKey:0,attr:function(a,b){return SC.RecordAttribute.attr(a,b).computed()},fetch:function(a,b){return SC.FetchedAttribute.attr(a,b).computed()},toMany:function(a,b){b=b||{};var c=b.nested||b.isNested,d;c?d=SC.ChildrenAttribute.attr(a,b):d=SC.ManyAttribute.attr(a,b);return d.computed()},toOne:function(a,b){b=b||{};var c=b.nested||b.isNested,d;c?d=SC.ChildAttribute.attr(a,b):d=SC.SingleAttribute.attr(a,b);return d.computed()},storeKeysById:function(){var a="storeKey-"+SC.guidFor(this),b=this[a];b||(b=this[a]={});return b},storeKeyFor:function(a){var b=this.storeKeysById(),c=b[a];c||(c=SC.Store.generateStoreKey(),SC.Store.idsByStoreKey[c]=a,SC.Store.recordTypesByStoreKey[c]=this,b[a]=c);return c},storeKeyExists:function(a){var b=this.storeKeysById(),c=b[a];return c},find:function(a,b){return a.find(this,b)},extend:function(){var a=SC.Object.extend.apply(this,arguments);a.aggregates=null,SC.Query._scq_didDefineRecordType(a);return a}}),f=SC.Record}({}),function(a){var b=SC.get,c=SC.set,d=SC.getPath;SC.RecordAttribute=SC.Object.extend({isRecordAttribute:YES,defaultValue:null,type:String,key:null,isRequired:NO,isEditable:YES,useIsoDate:YES,aggregate:NO,typeClass:function(){var a=b(this,"type");SC.typeOf(a)==="string"&&(a=d(a));return a}.property("type").cacheable(),transform:function(){var a=b(this,"typeClass")||String,c=SC.RecordAttribute.transforms,d;while(a&&!(d=c[SC.guidFor(a)]))a.superclass&&a.superclass.hasOwnProperty("create")?a=a.superclass:a="function";return d}.property("typeClass").cacheable(),toType:function(a,c,d){var e=b(this,"transform"),f=b(this,"typeClass"),g;if(e&&e.to){d=e.to(d,this,f,a,c);if(!SC.none(d)&&(g=e.observesChildren)){var h,i=g.length,j={record:a,key:c};for(h=0;h<i;h++)SC.addObserver(d,g[h],this,this._SCRA_childObserver,j)}}return d},_SCRA_childObserver:function(a,b,c,d){this.call(d.record,d.key,a),d.record.notifyPropertyChange(d.key)},fromType:function(a,c,d){var e=b(this,"transform"),f=b(this,"typeClass");e&&e.from&&(d=e.from(d,this,f,a,c));return d},call:function(a,c,d){var e=b(this,"key")||c,f;d!==undefined&&b(this,"isEditable")&&(f=this.fromType(a,c,d),a.writeAttribute(e,f)),f=d=a.readAttribute(e),SC.none(d)&&(d=b(this,"defaultValue"))?typeof d=="function"&&(d=this.defaultValue(a,c,this),f!==d&&b(a,"store").readDataHash(b(a,"storeKey"))&&a.writeAttribute(e,d,!0)):d=this.toType(a,c,d);return d},isProperty:YES,isCacheable:YES,dependentKeys:[],init:function(){this._super(),this.cacheKey="__cache__"+SC.guidFor(this),this.lastSetValueKey="__lastValue__"+SC.guidFor(this)},computed:function(){var a=this,b=SC.computed(function(b,c){return a.call(this,b,c)});b.attr=a;return b}}),SC.RecordAttribute.reopenClass({attr:function(a,b){b||(b={}),b.type||(b.type=a||String);return this.create(b)},transforms:{},registerTransform:function(a,b){SC.RecordAttribute.transforms[SC.guidFor(a)]=b},attrFor:function(a,b){var c=SC.meta(a,!1).descs[b];return c&&c.attr}}),SC.RecordAttribute.registerTransform(Boolean,{to:function(a){return SC.none(a)?null:!!a}}),SC.RecordAttribute.registerTransform(Number,{to:function(a){return SC.none(a)?null:Number(a)}}),SC.RecordAttribute.registerTransform(String,{to:function(a){typeof a!="string"&&!SC.none(a)&&a.toString&&(a=a.toString());return a}}),SC.RecordAttribute.registerTransform(Array,{to:function(a){!SC.isArray(a)&&!SC.none(a)&&(a=[]);return a},observesChildren:["[]"]}),SC.RecordAttribute.registerTransform(Object,{to:function(a){typeof a!="object"&&!SC.none(a)&&(a={});return a}}),SC.RecordAttribute.registerTransform(SC.Record,{to:function(a,c,d,e){var f=b(e,"store");return SC.none(a)||a===""?null:f.find(d,a)},from:function(a){return a?b(a,"id"):null}}),SC.RecordAttribute
.registerTransform("function",{to:function(a,c,d,e){d=d.apply(e);var f=b(e,"store");return f.find(d,a)},from:function(a){return b(a,"id")}}),SC.RecordAttribute.registerTransform(Date,{to:function(a,c){if(SC.none(a))return a;var d;a=a.toString()||"";if(b(c,"useIsoDate")){var e="([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(\\.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?",f=a.match(new RegExp(e)),g=0,h=new Date(f[1],0,1),i;f[3]&&h.setMonth(f[3]-1),f[5]&&h.setDate(f[5]),f[7]&&h.setHours(f[7]),f[8]&&h.setMinutes(f[8]),f[10]&&h.setSeconds(f[10]),f[12]&&h.setMilliseconds(Number("0."+f[12])*1e3),f[14]&&(g=Number(f[16])*60+Number(f[17]),g*=f[15]==="-"?1:-1),g-=h.getTimezoneOffset(),i=Number(h)+g*60*1e3,d=new Date,d.setTime(Number(i))}else d=new Date(Date.parse(a));return d},_dates:{},_zeropad:function(a){return(a<0?"-":"")+(a<10?"0":"")+Math.abs(a)},from:function(a){if(SC.none(a))return null;var b=this._dates[a.getTime()];if(b)return b;var c=this._zeropad,d=0-a.getTimezoneOffset()/60;d=d===0?"Z":"%@:00".fmt(c(d)),this._dates[a.getTime()]=b="%@-%@-%@T%@:%@:%@%@".fmt(c(a.getFullYear()),c(a.getMonth()+1),c(a.getDate()),c(a.getHours()),c(a.getMinutes()),c(a.getSeconds()),d);return b}}),SC.DateTime&&!SC.RecordAttribute.transforms[SC.guidFor(SC.DateTime)]&&SC.RecordAttribute.registerTransform(SC.DateTime,{to:function(a,c){if(SC.none(a)||a instanceof SC.DateTime)return a;if(SC.none(a)||a instanceof Date)return SC.DateTime.create(a.getTime());var d=b(c,"format");return SC.DateTime.parse(a,d?d:SC.DateTime.recordFormat)},from:function(a,c){if(SC.none(a))return a;var d=b(c,"format");return a.toFormattedString(d?d:SC.DateTime.recordFormat)}}),SC.RecordAttribute.registerTransform(SC.Set,{to:function(a,b,c,d,e){return SC.Set.create(a)},from:function(a,b,c,d,e){return a.toArray()},observesChildren:["[]"]})}({}),function(a){var b=SC.get,c=SC.set;SC.ChildAttribute=SC.RecordAttribute.extend({isNestedRecordTransform:YES,toType:function(a,c,d){var e=null,f,g=b(this,"typeClass");if(!a)throw"SC.Child: Error during transform: Unable to retrieve parent record.";SC.none(d)||(e=a.registerNestedRecord(d,c));return e},fromType:function(a,c,d){var e,f,g;a&&(SC.none(d)?(a.writeAttribute(c,d),g=d):(g=a.registerNestedRecord(d,c),g?(e=b(g,"storeKey"),f=b(g,"store"),a.writeAttribute(c,f.readDataHash(e))):d&&a.writeAttribute(c,d)));return g},call:function(a,c,d){var e=b(this,"key")||c,f,g="__kid__"+SC.guidFor(this);d!==undefined?d=this.fromType(a,c,d):(d=a.readAttribute(e),SC.none(d)&&(d=b(this,"defaultValue"))?typeof d=="function"&&(d=this.defaultValue(a,c,this),b(a,"attributes")&&a.writeAttribute(e,d,!0)):d=this.toType(a,c,d));return d}})}({}),function(a){var b=SC.get,c=SC.set,d=SC.getPath;SC.ChildArray=SC.Object.extend(SC.Enumerable,SC.Array,SC.MutableEnumerable,SC.MutableArray,{defaultRecordType:null,record:null,propertyName:null,children:null,store:function(){return d(this,"record.store")}.property("record").cacheable(),storeKey:function(){return d(this,"record.storeKey")}.property("record").cacheable(),readOnlyChildren:function(){return b(this,"record").readAttribute(b(this,"propertyName"))}.property(),editableChildren:function(){var a=b(this,"store"),c=b(this,"storeKey"),d=b(this,"propertyName"),e,f;e=a.readEditableProperty(c,d),e||(f=a.readEditableDataHash(c),e=f[d]=[]),e!==this._prevChildren&&this.recordPropertyDidChange();return e}.property(),length:function(){var a=b(this,"readOnlyChildren");return a?a.length:0}.property("readOnlyChildren"),objectAt:function(a){var c=this._records,d=b(this,"readOnlyChildren"),e,f,g=b(this,"propertyName"),h=b(this,"record"),i=d?d.length:0;if(!d)return undefined;if(c&&(f=c[a]))return f;c||(this._records=c=[]);if(a>=i)return undefined;e=d.objectAt(a);if(!e)return undefined;c[a]=f=h.registerNestedRecord(e,g,g+"."+a);return f},replace:function(a,c,d){var e=b(this,"editableChildren"),f=d?b(d,"length"):0,g=b(this,"record"),h,i=b(this,"propertyName"),j,k;h=this._processRecordsToHashes(d),e.replace(a,c,h),g.recordDidChange(i);return this},_processRecordsToHashes:function(a){var c,d;a=a||[],a.forEach(function(e,f){e instanceof SC.Record&&(c=b(e,"store"),d=b(e,"storeKey"),d&&(a[f]=c.readDataHash(d)))});return a},normalize:function(){this.forEach(function(a,b){a.normalize&&a.normalize()})},recordPropertyDidChange:function(a){if(a&&!a.contains(b(this,"propertyName")))return this;var c=b(this,"readOnlyChildren"),d=0,e=0,f=this._prevChildren,g=this._childrenContentDidChange;if(c===f)return this;f&&(f.removeArrayObserver(this,{willChange:this.arrayContentWillChange,didChange:g}),d=b(f,"length")),c&&(c.addArrayObserver(this,{willChange:this.arrayContentWillChange,didChange:g}),e=b(c,"length")),this.arrayContentWillChange(0,d,e),this._prevChildren=c,this._childrenContentDidChange(0,d,e);return this},_childrenContentDidChange:function(a,b,c){this._records=null,this.arrayContentDidChange(a,b,c)},init:function(){this._super(),this.recordPropertyDidChange()}})}({}),function(a){var b=SC.get,c=SC.set;SC.ChildrenAttribute=SC.ChildAttribute.extend({toType:function(a,d,e){var f=b(this,"key")||d,g="__kidsArray__"+SC.guidFor(this),h=a[g],i=b(this,"typeClass"),j;h||(h=SC.ChildArray.create({record:a,propertyName:f,defaultRecordType:i}),a[g]=h,j=b(a,"relationships"),j||c(a,"relationships",j=[]),j.push(h));return h},fromType:function(a,b,c){var d,e,f="__kidsArray__"+SC.guidFor(this),g=a[f];a&&(a.writeAttribute(b,c),g&&(g=g.recordPropertyDidChange()));return g}})}({}),function(a){var b=SC.get,c=SC.set,d=SC.RecordAttribute.attrFor;SC.ManyArray=SC.Object.extend(SC.Enumerable,SC.MutableEnumerable,SC.MutableArray,SC.Array,{recordType:null,record:null,propertyName:null,manyAttribute:null,store:function(){return b(b(this,"record"),"store")}.property("record").cacheable(),storeKey:function(){return b(b(this,"record"),"storeKey")}.property("record").cacheable(),readOnlyStoreIds:function(){return b(this,"record").readAttribute(b(this,"propertyName"))}.property(),editableStoreIds:function(){var a=b(this,"store"),c=b(this,"storeKey"),d=b(this,"propertyName"),e,f;e=a.readEditableProperty(c,d),e||(f=a.readEditableDataHash(c),e=f[d]=[]),e!==this._prevStoreIds&&this.recordPropertyDidChange();return e}.property(),isEditable:function(){var a=this.manyAttribute;return a?b(a,"isEditable"):NO}.property("manyAttribute").cacheable(),inverse:function(){var a=this.manyAttribute;return a?b(a,"inverse"):null}.property("manyAttribute").cacheable(),isMaster:function(){var a=this.manyAttribute;return a?b(a,"isMaster"):null}.property("manyAttribute").cacheable(),orderBy:function(){var a=this.manyAttribute;return a?b(a,"orderBy"):null}.property("manyAttribute").cacheable(),length:function(){var a=b(this,"readOnlyStoreIds");return a?b(a,"length"):0}.property("readOnlyStoreIds"),objectAt:function(a){var c=this._records,d=b(this,"readOnlyStoreIds"),e=b(this,"store"),f=b(this,"recordType"),g,h,i;if(!d||!e)return undefined;if(c&&(h=c[a]))return h;c||(this._records=c=[]),i=d.objectAt(a),i&&(g=e.storeKeyFor(f,i),e.readStatus(g)===SC.Record.EMPTY&&e.retrieveRecord(f,null,g),c[a]=h=e.materializeRecord(g));return h},replace:function(a,c,e){if(!b(this,"isEditable"))throw"%@.%@[] is not editable".fmt(b(this,"record"),b(this,"propertyName"));var f=b(this,"editableStoreIds"),g=e?b(e,"length"):0,h=b(this,"record"),i=b(this,"propertyName"),j,k,l,m,n,o,p;l=[];for(j=0;j<g;j++)l[j]=b(e.objectAt(j),"id");n=b(this,"inverse");if(n&&c>0){m=SC.ManyArray._toRemove,m?SC.ManyArray._toRemove=null:m=[];for(j=0;j<c;j++)m[j]=this.objectAt(a+j)}f.replace(a,c,l);if(n){for(j=0;j<c;j++)p=m[j],o=p?d(p,n):null,o&&o.inverseDidRemoveRecord&&o.inverseDidRemoveRecord(p,n,h,i);m&&(m.length=0,SC.ManyArray._toRemove||(SC.ManyArray._toRemove=m));for(j=0;j<g;j++)p=e.objectAt(j),o=p?d(p,n):null,o&&o.inverseDidAddRecord&&o.inverseDidAddRecord(p,n,h,i)}h&&(!n||b(this,"isMaster"))&&h.recordDidChange(i),this.enumerableContentDidChange(a,c,g-c);return this},removeInverseRecord:function(a){if(!a)return this;var c=b(a,"id"),d=b(this,"editableStoreIds"),e=d&&c?d.indexOf(c):-1,f;e>=0&&(d.removeAt(e),b(this,"isMaster")&&(f=b(this,"record"))&&f.recordDidChange(b(this,"propertyName")));return this},addInverseRecord:function(a){if(!a)return this;var c=b(a,"id"),d=b(this,"editableStoreIds"),e=b(this,"orderBy"),f=b(d,"length"),g,h;e?g=this._findInsertionLocation(a,0,f,e):g=f,d.insertAt(g,b(a,"id")),b(this,"isMaster")&&(h=b(this,"record"))&&h.recordDidChange(b(this,"propertyName"));return this},_findInsertionLocation:function(a,b,c,d){var e=b+Math.floor((c-b)/2),f=this.objectAt(e),g=this._compare(a,f,d);return g<0?e===0?e:this._findInsertionLocation(a,0,e,d):g>0?e>=c?e:this._findInsertionLocation(a,e,c,d):e},_compare:function(a,c,d){var e=SC.typeOf(d),f,g,h;if(e==="function")f=d(a,c);else if(e==="string")f=SC.compare(a,c);else{h=b(d,"length"),f=0;for(g=0;f===0&&g<h;g++)f=SC.compare(a,c)}return f},recordPropertyDidChange:function(a){if(a&&!a.contains(b(this,"propertyName")))return this;var c=b(this,"readOnlyStoreIds"),d,e,f=this._prevStoreIds,g=this._storeIdsContentDidChange;if(c===f)return this;f?(f.removeArrayObserver(this,{willChange:this.arrayContentWillChange,didChange:g}),d=b(f,"length")):d=0,c?(c.addArrayObserver(this,{willChange:this.arrayContentWillChange,didChange:g}),e=b(c,"length")):e=0,this.arrayContentWillChange(0,d,e),this._prevStoreIds=c,this._storeIdsContentDidChange(0,d,e)},_storeIdsContentDidChange:function(a,b,c){this._records=null,this.arrayContentDidChange(a,b,c)},init:function(){this._super(),this.recordPropertyDidChange()}})}({}),function(a){var b=SC.get,c=SC.set;SC.ManyAttribute=SC.RecordAttribute.extend({inverse:null,isMaster:YES,orderBy:null,toType:function(a,d,e){var f=b(this,"typeClass"),g=b(this,"key")||d,h="__manyArray__"+SC.guidFor(this),i=a[h],j;i||(i=SC.ManyArray.create({recordType:f,record:a,propertyName:g,manyAttribute:this}),a[h]=i,j=b(a,"relationships"),j||c(a,"relationships",j=[]),j.push(i));return i},fromType:function(a,c,d){var e=[];if(!SC.isArray(d))throw"Expects toMany attribute to be an array";var f=b(d,"length");for(var g=0;g<f;g++)e[g]=b(d.objectAt(g),"id");return e},inverseDidRemoveRecord:function(a,c,d,e){var f=b(a,c);f&&f.removeInverseRecord(d)},inverseDidAddRecord:function(a,c,d,e){var f=b(a,c);f&&f.addInverseRecord(d)}})}({}),function(a){var b=SC.get,c=SC.set,d=b(SC.RecordAttribute,"proto").call,e=SC.RecordAttribute.attrFor;SC.SingleAttribute=SC.RecordAttribute.extend({inverse:null,isMaster:YES,call:function(a,c,d){var f=b(this,"key")||c,g,h,i,j,k,l;if(d!==undefined&&b(this,"isEditable")){if(d&&!(d instanceof SC.Record))throw"%@ is not an instance of SC.Record".fmt(d);g=b(this,"inverse"),g&&(i=this._super(a,c)),l=this.fromType(a,c,d),a.writeAttribute(f,l,!b(this,"isMaster")),k=d,g&&i!==d&&(i&&(j=e(i,g))&&j.inverseDidRemoveRecord(i,g,a,c),d&&(j=e(d,g))&&j.inverseDidAddRecord(d,g,a,c))}else k=this._super(a,c,d);return k},inverseDidRemoveRecord:function(a,c,f,g){var h=b(this,"inverse"),i=d.call(this,a,c),j=b(this,"isMaster"),k;a.writeAttribute(c,null,!j),a.notifyPropertyChange(c),(i!==f||g!==h)&&i&&(k=e(i,h))&&k.inverseDidRemoveRecord(i,h,a,c)},inverseDidAddRecord:function(a,c,f,g){var h=b(this,"inverse"),i=d.call(this,a,c),j=b(this,"isMaster"),k,l;l=this.fromType(a,c,f),a.writeAttribute(c,l,!j),a.notifyPropertyChange(c),(i!==f||g!==h)&&i&&(k=e(i,h))&&k.inverseDidRemoveRecord(i,h,a,c)}})}({}),function(a){}({}),function(a){SC.MIXED_STATE="__MIXED__",SC.DataSource=SC.Object.extend({fetch:function(a,b){return NO},retrieveRecords:function(a,b,c){return this._handleEach(a,b,this.retrieveRecord,c)},commitRecords:function(a,b,c,d,e){var f,g,h;b.length>0&&(h=this.createRecords.call(this,a,b,e)),c.length>0&&(f=this.updateRecords.call(this,a,c,e),h=SC.none(h)?f:h===f?h:SC.MIXED_STATE),d.length>0&&(g=this.destroyRecords.call(this,a,d,e),h=SC.none(h)?g:h===g?h:SC.MIXED_STATE);return h||NO},cancel:function(a,b){return NO},updateRecords:function(a,b,c){return this._handleEach(a,b,this.updateRecord,null,c)},createRecords:function(a,b,c){return this._handleEach(a,b,this.createRecord,null,c)},destroyRecords:function(a,b,c){return this._handleEach(a,b,this.destroyRecord,null,c)},_handleEach:function(a,b,c,d,e){var f=b.length,g,h,i,j;for(g=0;g<f;g++)j=d?d[g]:e,i=c.call(this,a,b[g],j),h===undefined?h=i:h===YES?h=i===YES?YES:SC.MIXED_STATE:h===NO&&(h=i===NO?NO:SC.MIXED_STATE);return SC.none(h)?null:h},updateRecord:function(a,b,c){return NO},retrieveRecord:function(a,b,c){return NO},createRecord:function(a,b,c){return NO},destroyRecord:function(a,b,c){return NO}})}({}),function(a){var b=SC.get,c=SC.set;SC.CascadeDataSource=SC.DataSource.extend({dataSources:null,from:function(a){var d=b(this,"dataSources");d||c(this,"dataSources",d=[]),d.push(a);return this},fetch:function(a,c){var d=b(this,"dataSources"),e=d?d.length:0,f=NO,g,h,i;for(i=0;f!==YES&&i<e;i++)h=d.objectAt(i),g=h.fetch?h.fetch.apply(h,arguments):NO,f=this._handleResponse(f,g);return f},retrieveRecords:function(a,c,d){var e=b(this,"dataSources"),f=e?e.length:0,g=NO,h,i,j;for(j=0;g!==YES&&j<f;j++)i=e.objectAt(j),h=i.retrieveRecords.apply(i,arguments),g=this._handleResponse(g,h);return g},commitRecords:function(a,c,d,e,f){var g=b(this,"dataSources"),h=g?g.length:0,i=NO,j,k,l;for(l=0;i!==YES&&l<h;l++)k=g.objectAt(l),j=k.commitRecords.apply(k,arguments),i=this._handleResponse(i,j);return i},cancel:function(a,c){var d=b(this,"dataSources"),e=d?d.length:0,f=NO,g,h,i;for(i=0;f!==YES&&i<e;i++)h=d.objectAt(i),g=h.cancel.apply(h,arguments),f=this._handleResponse(f,g);return f},init:function(){this._super();var a=b(this,"dataSources"),c=a?b(a,"length"):0,d;while(--c>=0)d=a[c],SC.typeOf(d)==="string"&&(a[c]=b(this,d))},_handleResponse:function(a,b){return b===YES?YES:a===NO?b===NO?NO:SC.MIXED_STATE:SC.MIXED_STATE}})}({}),function(a){var b=SC.get,c=SC.set,d=SC.getPath;SC.FixturesDataSource=SC.DataSource.extend({simulateRemoteResponse:NO,latency:50,cancel:function(a,b){return NO},fetch:function(a,c){if(b(c,"location")!==SC.Query.LOCAL)throw SC.$error("SC.Fixture data source can only fetch local queries");if(!b(c,"recordType")&&!b(c,"recordTypes"))throw SC.$error("SC.Fixture data source can only fetch queries with one or more record types");b(this,"simulateRemoteResponse")?this.invokeLater(this._fetch,b(this,"latency"),a,c):this._fetch(a,c)},_fetch:function(a,c){var e=b(c,"recordType"),f=b(c,"recordTypes")||[e];f.forEach(function(b){SC.typeOf(b)==="string"&&(b=d(b)),b&&this.loadFixturesFor(a,b)},this),a.dataSourceDidFetchQuery(c)},retrieveRecords:function(a,c){var d=b(this,"latency"),e=this.hasFixturesFor(c);if(!e)return e;b(this,"simulateRemoteResponse")?this.invokeLater(this._retrieveRecords,d,a,c):this._retrieveRecords(a,c);return e},_retrieveRecords:function(a,b){b.forEach(function(b){var c=[],d=SC.Store.recordTypeFor(b),e=a.idFor(b),f=this.fixtureForStoreKey(a,b);c.push(b),a.dataSourceDidComplete(b,f,e)},this)},updateRecords:function(a,c,d){var e=b(this,"latency"),f=this.hasFixturesFor(c);if(!f)return f;b(this,"simulateRemoteResponse")?this.invokeLater(this._updateRecords,e,a,c):this._updateRecords(a,c);return f},_updateRecords:function(a,b){b.forEach(function(b){var c=a.readDataHash(b);this.setFixtureForStoreKey(a,b,c),a.dataSourceDidComplete(b)},this)},createRecords:function(a,c,d){var e=b(this,"latency");b(this,"simulateRemoteResponse")?this.invokeLater(this._createRecords,e,a,c):this._createRecords(a,c);return YES},_createRecords:function(a,b){b.forEach(function(b){var c=a.idFor(b),d=a.recordTypeFor(b),e=a.readDataHash(b),f=this.fixturesFor(d);c||(c=this.generateIdFor(d,e,a,b)),this._invalidateCachesFor(d,b,c),f[c]=e,a.dataSourceDidComplete(b,null,c)},this)},destroyRecords:function(a,c,d){var e=b(this,"latency"),f=this.hasFixturesFor(c);if(!f)return f;b(this,"simulateRemoteResponse")?this.invokeLater(this._destroyRecords,e,a,c):this._destroyRecords(a,c);return f},_destroyRecords:function(a,b){b.forEach(function(b){var c=a.idFor(b),d=a.recordTypeFor(b),e=this.fixturesFor(d);this._invalidateCachesFor(d,b,c),c&&delete e[c],a.dataSourceDidDestroy(b)},this)},loadFixturesFor:function(a,b,c){var d=[],e,f,g;e=this.fixturesFor(b);for(f in e)g=b.storeKeyFor(f),a.peekStatus(g)===SC.Record.EMPTY&&d.push(e[f]),c&&c.push(g);d&&d.length>0&&a.loadRecords(b,d);return this},generateIdFor:function(a,b,c,d){return"@id%@".fmt(SC.Store.generateStoreKey())},fixtureForStoreKey:function(a,b){var c=a.idFor(b),d=a.recordTypeFor(b),e=this.fixturesFor(d);return e?e[c]:null},setFixtureForStoreKey:function(a,b,c){var d=a.idFor(b),e=a.recordTypeFor(b),f=this.fixturesFor(e);this._invalidateCachesFor(e,b,d),f[d]=c;return this},fixturesFor:function(a){this._fixtures||(this._fixtures={});var c=this._fixtures[SC.guidFor(a)];if(c)return c;var d=a?a.FIXTURES:null,e=d?d.length:0,f=a?b(a,"proto").primaryKey:"guid",g,h,i;this._fixtures[SC.guidFor(a)]=c={};for(g=0;g<e;g++)h=d[g],i=h[f],i||(i=this.generateIdFor(a,h)),c[i]=h;return c},fixturesLoadedFor:function(a){if(!this._fixtures)return NO;var b=[],c=this._fixtures[SC.guidFor(a)];return c?YES:NO},hasFixturesFor:function(a){var b=NO;a.forEach(function(a){if(b!==SC.MIXED_STATE){var c=SC.Store.recordTypeFor(a),d=c?c.FIXTURES:null;d&&d.length&&d.length>0?b===NO&&(b=YES):b===YES&&(b=SC.MIXED_STATE)}},this);return b},_invalidateCachesFor:function(a,b,c){var d=this._storeKeyCache;d&&delete d[SC.guidFor(a)];return this}}),SC.Record.fixtures=SC.FixturesDataSource.create()}({}),function(a){}({}),function(a){var b=SC.get,c=SC.set;SC.RecordArray=SC.Object.extend(SC.Enumerable,SC.Array,SC.MutableEnumerable,SC.MutableArray,{store:null,query:null,storeKeys:null,status:SC.Record.EMPTY,isEditable:function(){var a=b(this,"query");return a?b(a,"isEditable"):YES}.property("query").cacheable(),length:function(){this.flush();var a=b(this,"storeKeys");return a?b(a,"length"):0}.property("storeKeys").cacheable(),_scra_records:null,objectAt:function(a){this.flush();var c=this._scra_records,d=b(this,"storeKeys"),e=b(this,"store"),f,g;if(!d||!e)return undefined;if(c&&(g=c[a]))return g;c||(this._scra_records=c=[]),f=d.objectAt(a),f&&(e.peekStatus(f)===SC.Record.EMPTY&&e.retrieveRecord(null,null,f),c[a]=g=e.materializeRecord(f));return g},forEach:function(a,c){this.flush();var d=this._scra_records,e=b(this,"storeKeys"),f=b(this,"store"),g=e?b(e,"length"):0,h,i,j;if(!e||!f)return this;d||(d=this._scra_records=[]),c||(c=this);for(h=0;h<g;h++)j=d[h],j||(j=d[h]=f.materializeRecord(e.objectAt(h))),a.call(c,j,h,this);return this},replace:function(a,c,d){this.flush();var e=b(this,"storeKeys"),f=d?b(d,"length"):0,g,h;if(!e)throw"Unable to edit an SC.RecordArray that does not have its storeKeys property set.";if(!b(this,"isEditable"))throw SC.RecordArray.NOT_EDITABLE;h=[];for(g=0;g<f;g++)h[g]=b(d.objectAt(g),"storeKey");e.replace(a,c,h);return this},contains:function(a){return this.indexOf(a)>=0},indexOf:function(a,c){if(!(a instanceof SC.Record)){SC.Logger.warn("Using indexOf on %@ with an object that is not an SC.Record".fmt(a));return-1}this.flush();var d=b(a,"storeKey"),e=b(this,"storeKeys");return e?e.indexOf(d,c):-1},lastIndexOf:function(a,c){if(!(a instanceof SC.Record)){SC.Logger.warn("Using lastIndexOf on %@ with an object that is not an SC.Record".fmt(a));return-1}this.flush();var d=b(a,"storeKey"),e=b(this,"storeKeys");return e?e.lastIndexOf(d,c):-1},add:function(a){if(!(a instanceof SC.Record))return this;this.indexOf(a)<0&&this.pushObject(a);return this},remove:function(a){if(!(a instanceof SC.Record))return this;this.removeObject(a);return this},find:function(a,c){return a&&a.isQuery?b(this,"store").find(a.queryWithScope(this)):this._super(a,c)},refresh:function(){b(this,"store").refreshQuery(b(this,"query"));return this},reload:function(){this.flush(YES);return this},destroy:function(){b(this,"isDestroyed")||b(this,"store").recordArrayWillDestroy(this),this._super()},storeWillFetchQuery:function(a){var d=b(this,"status"),e=SC.Record;if(d===e.EMPTY||d===e.ERROR)d=e.BUSY_LOADING;d&e.READY&&(d=e.BUSY_REFRESH),c(this,"status",d);return this},storeDidFetchQuery:function(a){c(this,"status",SC.Record.READY_CLEAN);return this},storeDidCancelQuery:function(a){var d=b(this,"status"),e=SC.Record;d===e.BUSY_LOADING?d=e.EMPTY:d===e.BUSY_REFRESH&&(d=e.READY_CLEAN),c(this,"status",d);return this},storeDidErrorQuery:function(a){c(this,"status",SC.Record.ERROR);return this},storeDidChangeStoreKeys:function(a,d){var e=b(this,"query");if(b(e,"location")!==SC.Query.LOCAL)return this;if(!e.containsRecordTypes(d))return this;var f=this._scq_changedStoreKeys;f||(f=this._scq_changedStoreKeys=SC.IndexSet.create()),f.addEach(a),c(this,"needsFlush",YES),b(this,"storeKeys")&&this.flush();return this},flush:function(a){if(this._insideFlush){c(this,"needsFlush",YES);return this}if(!b(this,"needsFlush")&&!a)return this;c(this,"needsFlush",NO);var d=b(this,"query"),e=b(this,"store");if(!e||!d||b(d,"location")!==SC.Query.LOCAL)return this;this._insideFlush=YES;var f=b(this,"storeKeys"),g=this._scq_changedStoreKeys,h=NO,i=SC.Record,j=[],k=new Date,l,m,n,o,p,q,r=f;if(f&&!a)g&&(g.forEach(function(a){j.length>0||new Date-k>SC.RecordArray.QUERY_MATCHING_THRESHOLD?j.push(a):(m=e.peekStatus(a),!(m&i.EMPTY)&&!(m&i.DESTROYED||m===i.BUSY_DESTROYING)?(l=e.materializeRecord(a),q=!!l&&!!d.contains(l)):q=NO,q?f.indexOf(a)<0&&(h||(f=f.copy()),f.pushObject(a)):f.indexOf(a)>=0&&(h||(f=f.copy()),f.removeObject(a)))},this),h=YES);else{if(p=b(d,"scope"))o=b(p.flush(),"storeKeys");else if(n=b(d,"expandedRecordTypes"))o=SC.IndexSet.create(),n.forEach(function(a){o.addEach(e.storeKeysFor(n))});f=[],o.forEach(function(a){j.length>0||new Date-k>SC.RecordArray.QUERY_MATCHING_THRESHOLD?j.push(a):(m=e.peekStatus(a),!(m&i.EMPTY)&&!(m&i.DESTROYED||m===i.BUSY_DESTROYING)&&(l=e.materializeRecord(a),l&&d.contains(l)&&f.push(a)))}),h=YES}if(j.length>0){var s=this;window.setTimeout(function(){SC.run(function(){!!s&&!b(s,"isDestroyed")&&(c(s,"needsFlush",YES),s._scq_changedStoreKeys=SC.IndexSet.create().addEach(j),s.flush())})},1)}g&&g.clear(),h&&(f&&f===r&&(f=f.copy()),f=SC.Query.orderStoreKeys(f,d,e),SC.compare(r,f)!==0&&c(this,"storeKeys",SC.copy(f))),this._insideFlush=NO;return this},needsFlush:YES,isError:function(){return b(this,"status")&SC.Record.ERROR}.property("status").cacheable(),errorValue:function(){return b(this,"isError")?SC.val(b(this,"errorObject")):null}.property("isError").cacheable(),errorObject:function(){if(b(this,"isError")){var a=b(this,"store");return a.readQueryError(b(this,"query"))||SC.Record.GENERIC_ERROR}return null}.property("isError").cacheable(),propertyWillChange:function(a){if(a==="storeKeys"){var c=b(this,"storeKeys"),d=c?b(c,"length"):0;this.arrayContentWillChange(0,d,0)}return this._super(a)},_storeKeysDidChange:function(){var a=b(this,"storeKeys"),c=this._prevStoreKeys,d,e,f=this._storeKeysContentDidChange,g=this._storeKeysStateDidChange;a!==c&&(d=c?b(c,"length"):0,e=a?b(a,"length"):0,this._storeKeysContentWillChange(c,0,d,e),c&&c.removeArrayObserver(this,{willChange:this._storeKeysContentWillChange,didChange:this._storeKeysContentDidChange}),this._prevStoreKeys=a,a&&a.addArrayObserver(this,{willChange:this._storeKeysContentWillChange,didChange:this._storeKeysContentDidChange}),this._storeKeysContentDidChange(a,0,d,e))}.observes("storeKeys"),addArrayObserver:function(){this.flush();return this._super.apply(this,arguments)},_storeKeysContentWillChange:function(a,b,c,d){this.arrayContentWillChange(b,c,d)},_storeKeysContentDidChange:function(a,b,c,d){this._scra_records&&(this._scra_records.length=0),this.arrayContentDidChange(b,c,d)},init:function(){this._super(),this._storeKeysDidChange()}}),SC.RecordArray.reopenClass({NOT_EDITABLE:SC.StoreError.desc("SC.RecordArray is not editable"),QUERY_MATCHING_THRESHOLD:100})}({}),function(a){var b=SC.get,c=SC.set,d=SC.getPath,e=SC.none;SC.Store=SC.Object.extend({name:null,nestedStores:null,dataSource:null,isNested:NO,commitRecordsAutomatically:NO,from:function(a){c(this,"dataSource",a);return this},_getDataSource:function(){var a=b(this,"dataSource");typeof a=="string"&&(a=d(a),a&&a.isClass&&(a=a.create()),a&&c(this,"dataSource",a));return a},cascade:function(a){var b=Array.prototype.slice.call(arguments);a=SC.CascadeDataSource.create({dataSources:b});return this.from(a)},chain:function(a,b){a||(a={}),a.parentStore=this,b||(b=SC.NestedStore),sc_assert("%@ is a valid class".fmt(b),SC.typeOf(b)==="class"),sc_assert("%@ is a type of SC.NestedStore".fmt(b),SC.NestedStore.detect(b)),a.childRecords=this.childRecords?SC.copy(this.childRecords):{},a.parentRecords=this.parentRecords?SC.copy(this.parentRecords):{};var c=b.create(a),d=this.nestedStores;d||(d=this.nestedStores=[]),d.push(c);return c},willDestroyNestedStore:function(a){this.nestedStores&&this.nestedStores.removeObject(a);return this},hasNestedStore:function(a){while(a&&a!==this)a=b(a,"parentStore");return a===this},dataHashes:null,statuses:null,revisions:null,editables:null,changelog:null,recordErrors:null,queryErrors:null,childRecords:null,parentRecords:null,storeKeyEditState:function(a){var b=this.editables,c=this.locks;return b&&b[a]?SC.Store.EDITABLE:SC.Store.LOCKED},readDataHash:function(a){return this.dataHashes[a]},readEditableDataHash:function(a){var b=this.dataHashes[a];if(!b)return b;var c=this.editables;c||(c=this.editables=[]),c[a]||(c[a]=1,b=this.dataHashes[a]=SC.copy(b,YES));return b},readEditableProperty:function(a,b){var c=this.readEditableDataHash(a),d=this.editables[a],e=c[b];d===1&&(d=this.editables[a]={}),d[b]||(e=c[b],e&&e.isCopyable&&(e=c[b]=e.copy(YES)),d[b]=YES);return e},writeDataHash:function(a,b,c){b&&(this.dataHashes[a]=b),c&&(this.statuses[a]=c);var d=this.editables;d||(d=this.editables=[]),d[a]=1;var e=this;this._propagateToChildren(a,function(a){e.writeDataHash(a,null,c)});return this},removeDataHash:function(a,b){this.dataHashes[a]=null,this.statuses[a]=b||SC.Record.EMPTY;var c=this.editables;c&&(c[a]=0);return this},readStatus:function(a){this.readDataHash(a);return this.statuses[a]||SC.Record.EMPTY},peekStatus:function(a){return this.statuses[a]||SC.Record.EMPTY},writeStatus:function(a,b){return this.writeDataHash(a,null,b)},dataHashDidChange:function(a,b,c,d){function j(a){i.dataHashDidChange(a,null,c,d)}b||(b=SC.Store.generateStoreKey());var e,f,g,h;e=SC.typeOf(a)==="array",e?f=a.length:(f=1,h=a);var i=this;for(g=0;g<f;g++)e&&(h=a[g]),this.revisions[h]=b,this._notifyRecordPropertyChange(h,c,d),this._propagateToChildren(h,j);return this},_notifyRecordPropertyChange:function(a,c,d){var e=this.records,f=b(this,"nestedStores"),g=SC.Store,h,i,j,k,l,m,n;j=f?f.length:0;for(k=0;k<j;k++){l=f[k],m=l.peekStatus(a),i=l.storeKeyEditState(a);if(i===g.INHERITED)l._notifyRecordPropertyChange(a,c,d);else if(m&SC.Record.BUSY){if(b(l,"hasChanges"))throw g.CHAIN_CONFLICT_ERROR;l.reset()}}var o=this.recordPropertyChanges;o||(o=this.recordPropertyChanges={storeKeys:SC.Set.create(),records:SC.Set.create(),hasDataChanges:SC.Set.create(),propertyForStoreKeys:{}}),o.storeKeys.add(a),e&&(h=e[a])&&(o.records.push(a),c||o.hasDataChanges.push(a),d?((n=o.propertyForStoreKeys[a])||(n=o.propertyForStoreKeys[a]=SC.Set.create()),n!=="*"&&n.add(d)):o.propertyForStoreKeys[a]="*"),SC.run.once(this,this.flush);return this},flush:function(){if(!this.recordPropertyChanges)return this;var a=this.recordPropertyChanges,c=a.storeKeys,d=a.hasDataChanges,e=a.records,f=a.propertyForStoreKeys,g=SC.Set.create(),h,i,j,k,l,m,n;c.forEach(function(a){e.contains(a)&&(j=d.contains(a)?NO:YES,h=this.records[a],n=f?f[a]:null,n==="*"&&(n=null),e.remove(a),h&&h.storeDidChangeProperties(j,n)),i=SC.Store.recordTypeFor(a),g.add(i)},this),b(c,"length")>0&&this._notifyRecordArrays(c,g),c.clear(),d.clear(),e.clear(),this.recordPropertyChanges.propertyForStoreKeys={};return this},reset:function(){this.dataHashes={},this.revisions={},this.statuses={},this.chainedChanges=this.locks=this.editables=null,this.changelog=null,this.recordErrors=null,this.queryErrors=null;var a=this.records,b;if(a)for(b in a){if(!a.hasOwnProperty(b))continue;this._notifyRecordPropertyChange(parseInt(b,10),NO)}c(this,"hasChanges",NO)},commitChangesFromNestedStore:function(a,c,d){d||this._verifyLockRevisions(c,a.locks);var e=c.length,f,g,h,i,j,k,l,m,n,o,p,q,r;k=this.revisions,h=this.dataHashes,i=this.statuses,j=this.editables,l=this.parentRecords?this.parentRecords:this.parentRecords={},m=this.childRecords?this.childRecords:this.childRecords={},j||(j=this.editables=[]),n=a.dataHashes,p=a.revisions,o=a.statuses,q=a.parentRecords||{},r=a.childRecords||{};for(f=0;f<e;f++)g=c[f],h[g]=n[g],i[g]=o[g],k[g]=p[g],l[g]=q[g],m[g]=r[g],j[g]=0,this._notifyRecordPropertyChange(g,NO);var s=this.changelog,t=a.changelog;t&&(s||(s=this.changelog=SC.Set.create()),s.addEach(t)),this.changelog=s,b(this,"parentStore")||this.flush();return this},_verifyLockRevisions:function(a,b){var c=a.length,d=this.revisions,e,f,g,h;if(b&&d)for(e=0;e<c;e++){f=a[e],g=b[f]||1,h=d[f]||1;if(g<h)throw SC.Store.CHAIN_CONFLICT_ERROR}return this},find:function(a,b){"string"==typeof a&&(a=d(a));if(b!==undefined||a instanceof SC.Record)return this._findRecord(a,b);sc_assert("SC.Store#find() accepts only a record type of query",SC.Record.detect(a)||a instanceof SC.Query),a instanceof SC.Query||(a=SC.Query.local(a));return this._findQuery(a,YES,YES)},findAll:function(a,b,c){SC.Logger.warn("SC.Store#findAll() will be removed in a future version of SproutCore.  Use SC.Store#find() instead");if(!a||!a.isQuery)a=SC.Query.local(a,b,c);return this._findQuery(a,YES,YES)},_findQuery:function(a,d,e){var f=this._scst_recordArraysByQuery,g=SC.guidFor(a),h,i;f||(f=this._scst_recordArraysByQuery={}),h=f[g],!h&&d&&(f[g]=h=SC.RecordArray.create({store:this,query:a}),i=b(this,"recordArrays"),i||c(this,"recordArrays",i=SC.Set.create()),i.add(h),e&&this.refreshQuery(a)),this.flush();return h},_findRecord:function(a,c){var d;a&&a instanceof SC.Record?d=b(a,"storeKey"):d=c?a.storeKeyFor(c):null,d&&this.readStatus(d)===SC.Record.EMPTY&&(d=this.retrieveRecord(a,c));return d?this.materializeRecord(d):null},recordArrayWillDestroy:function(a){var c=this._scst_recordArraysByQuery,d=b(this,"recordArrays");c&&delete c[SC.guidFor(b(a,"query"))],d&&d.remove(a);return this},refreshQuery:function(a){if(!a)throw new Error("refreshQuery() requires a query");var b=this._scst_recordArraysByQuery,c=b?b[SC.guidFor(a)]:null,d=this._getDataSource();d&&d.fetch&&(c&&c.storeWillFetchQuery(a),d.fetch.call(d,this,a));return this},_notifyRecordArrays:function(a,c){var d=b(this,"recordArrays");if(!d)return this;d.forEach(function(b){b&&b.storeDidChangeStoreKeys(a,c)},this);return this},recordsFor:function(a){var b=[],c=a.storeKeysById(),d,e,f;for(d in c)e=c[d],this.readStatus(e)!==SC.RECORD_EMPTY&&b.push(e);b.length>0?f=SC.RecordArray.create({store:this,storeKeys:b}):f=b;return f},_TMP_REC_ATTRS:{},materializeRecord:function(a){var b=this.records,c,d,e;b||(b=this.records={}),c=b[a];if(c)return c;d=SC.Store.recordTypeFor(a);if(!d)return null;e=this._TMP_REC_ATTRS,e.storeKey=a,e.store=this,c=b[a]=d.create(e);return c},createRecord:function(a,c,d){var e,f,g,h=SC.Record,i,j,k,l;!d&&(e=b(a,"proto").primaryKey)&&(d=c[e],l=SC.RecordAttribute.attrFor(b(a,"proto"),e),j=l&&b(l,"defaultValue"),!d&&SC.typeOf(j)==="function"&&(d=c[e]=j())),f=d?a.storeKeyFor(d):SC.Store.generateStoreKey(),g=this.readStatus(f);if(g&h.BUSY||g&h.READY||g===h.DESTROYED_DIRTY)throw d?h.RECORD_EXISTS_ERROR:h.BAD_STATE_ERROR;if(!d&&(g===SC.DESTROYED_CLEAN||g===SC.StoreError))throw h.BAD_STATE_ERROR;this.writeDataHash(f,c?c:{},h.READY_NEW),SC.Store.replaceRecordTypeFor(f,a),this.dataHashDidChange(f),i=this.changelog,i||(i=SC.Set.create()),i.add(f),this.changelog=i,b(this,"commitRecordsAutomatically")&&SC.run.schedule("actions",this,this.commitRecords),k=this.materializeRecord(f),k&&k.propagateToAggregates();return k},createRecords:function(a,b,c){var d=[],e,f,g,h=b.length,i;g=SC.typeOf(a)==="array",g||(e=a);for(i=0;i<h;i++)g&&(e=a[i]||SC.Record),f=c?c[i]:undefined,d.push(this.createRecord(e,b[i],f));return d},unloadRecord:function(a,b,c,d){c===undefined&&(c=a.storeKeyFor(b));var e=this.readStatus(c),f=SC.Record;d=d||f.EMPTY;if(e===f.BUSY_DESTROYING||e&f.DESTROYED)return this;if(e&f.BUSY)throw f.BUSY_ERROR;e=d,this.removeDataHash(c,e),this.dataHashDidChange(c);var g=this;this._propagateToChildren(c,function(a){g.unloadRecord(null,null,a,d)});return this},unloadRecords:function(a,b,c,d){var e,f,g,h,i,j;if(c===undefined){f=SC.typeOf(a)==="array",f||(i=a);if(b===undefined){e=f?a.length:1;for(g=0;g<e;g++)f&&(i=a[g]),c=this.storeKeysFor(i),this.unloadRecords(undefined,undefined,c,d)}else{e=b.length;for(g=0;g<e;g++)f&&(i=a[g]||SC.Record),h=b?b[g]:undefined,this.unloadRecord(i,h,undefined,d)}}else{e=c.length;for(g=0;g<e;g++)j=c?c[g]:undefined,this.unloadRecord(undefined,undefined,j,d)}return this
},destroyRecord:function(a,c,d){d===undefined&&(d=a.storeKeyFor(c));var e=this.readStatus(d),f,g=SC.Record;if(e===g.BUSY_DESTROYING||e&g.DESTROYED)return this;if(e===g.EMPTY)throw g.NOT_FOUND_ERROR;if(e&g.BUSY)throw g.BUSY_ERROR;e===g.READY_NEW?e=g.DESTROYED_CLEAN:e=g.DESTROYED_DIRTY,this.writeStatus(d,e),this.dataHashDidChange(d),f=this.changelog,f||(f=this.changelog=SC.Set.create()),e&g.DIRTY?f.add(d):f.remove(d),this.changelog=f,b(this,"commitRecordsAutomatically")&&SC.run.schedule("actions",this,this.commitRecords);var h=this;this._propagateToChildren(d,function(a){h.destroyRecord(null,null,a)});return this},destroyRecords:function(a,b,c){var d,e,f,g,h,i;if(c===undefined){d=b.length,e=SC.typeOf(a)==="array",e||(h=a);for(f=0;f<d;f++)e&&(h=a[f]||SC.Record),g=b?b[f]:undefined,this.destroyRecord(h,g,undefined)}else{d=c.length;for(f=0;f<d;f++)i=c?c[f]:undefined,this.destroyRecord(undefined,undefined,i)}return this},registerChildToParent:function(a,b,c){var d,e,f,g,h;e=this.childRecords||{},d=this.parentRecords||{},f=e[b],f&&(g=d[f],delete g[b]),h=d[a]||{},h[b]=c||YES,d[a]=h,e[b]=a,this.writeStatus(b,this.statuses[a]),this.childRecords=e,this.parentRecords=d},materializeParentRecord:function(a){var b,c;if(e(a))return null;c=this.childRecords,b=c?this.childRecords[a]:null;if(e(b))return null;return this.materializeRecord(b)},parentStoreKeyExists:function(a){if(!e(a)){var b=this.childRecords||{};return b[a]}},_propagateToChildren:function(a,b){if(!e(this.parentRecords)){var c=this.parentRecords[a]||{};if(e(b))return;for(var d in c)c.hasOwnProperty(d)&&b(d)}},recordDidChange:function(a,c,d,e,f){d===undefined&&(d=a.storeKeyFor(c));var g=this.readStatus(d),h,i=SC.Record;if(g&i.BUSY)throw i.BUSY_ERROR;if(!(g&i.READY))throw i.NOT_FOUND_ERROR;g!=i.READY_NEW&&this.writeStatus(d,i.READY_DIRTY),this.dataHashDidChange(d,null,f,e),h=this.changelog,h||(h=this.changelog=SC.Set.create()),h.add(d),this.changelog=h,b(this,"commitRecordsAutomatically")&&SC.run.schedule("actions",this,this.commitRecords);return this},recordsDidChange:function(a,b,c){var d,e,f,g,h,i;if(c===undefined){d=b.length,e=SC.typeOf(a)==="array",e||(h=a);for(f=0;f<d;f++)e&&(h=a[f]||SC.Record),g=b?b[f]:undefined,i=c?c[f]:undefined,this.recordDidChange(h,g,i)}else{d=c.length;for(f=0;f<d;f++)i=c?c[f]:undefined,this.recordDidChange(undefined,undefined,i)}return this},retrieveRecords:function(a,b,c,d,e){var f=this._getDataSource(),g=SC.typeOf(a)==="array",h=SC.typeOf(e)==="array",i=c?c.length:b.length,j=[],k=SC.Store.generateStoreKey(),l=SC.Record,m,n,o,p,q,r;g||(m=a);for(n=0;n<i;n++){c?o=c[n]:(g&&(m=a[n]),o=m.storeKeyFor(b[n])),r=h?e[n]:e,p=this.readStatus(o);if(p==l.EMPTY||p==l.ERROR||p==l.DESTROYED_CLEAN)this.writeStatus(o,l.BUSY_LOADING),this.dataHashDidChange(o,k,YES),j.push(o),this._setCallbackForStoreKey(o,r,h,c);else if(d)if(p&l.READY)this.writeStatus(o,l.BUSY_REFRESH|p&3),this.dataHashDidChange(o,k,YES),j.push(o),this._setCallbackForStoreKey(o,r,h,c);else{if(p==l.BUSY_DESTROYING||p==l.BUSY_CREATING||p==l.BUSY_COMMITTING)throw l.BUSY_ERROR;if(p==l.DESTROYED_DIRTY)throw l.BAD_STATE_ERROR}}q=NO,f&&(q=f.retrieveRecords.call(f,this,j,b));if(!q){i=j.length,k=SC.Store.generateStoreKey();for(n=0;n<i;n++)o=j[n],p=this.readStatus(o),p===l.BUSY_LOADING?(this.writeStatus(o,l.ERROR),this.dataHashDidChange(o,k,YES)):p&l.BUSY_REFRESH&&(this.writeStatus(o,l.READY|p&3),this.dataHashDidChange(o,k,YES));j.length=0}return j},_TMP_RETRIEVE_ARRAY:[],_callback_queue:{},_setCallbackForStoreKey:function(a,b,c,d){var e=this._callback_queue;c?e[a]={callback:b,otherKeys:d}:e[a]=b},_retreiveCallbackForStoreKey:function(a){var b=this._callback_queue,c=b[a],d,e;c&&(SC.typeOf(c)==="function"?(c.call(),delete b[a]):SC.typeOf(c)=="object"&&(c.completed=YES,e=c.storeKeys,e.forEach(function(a){b[a].completed||(d=YES)}),d&&(c.callback.call(),e.forEach(function(a){delete b[a]}))))},_cancelCallback:function(a){var b=this._callback_queue;b[a]&&delete b[a]},retrieveRecord:function(a,b,c,d,e){var f=this._TMP_RETRIEVE_ARRAY,g;c?(f[0]=c,c=f,b=null):(f[0]=b,b=f),g=this.retrieveRecords(a,b,c,d,e),f.length=0;return g[0]},refreshRecord:function(a,b,c,d){return!!this.retrieveRecord(a,b,c,YES,d)},refreshRecords:function(a,b,c,d){var e=this.retrieveRecords(a,b,c,YES,d);return e&&e.length>0},commitRecords:function(a,c,d,e,f){var g=this._getDataSource(),h=SC.typeOf(a)==="array",i=SC.typeOf(f)==="array",j=[],k=[],l=[],m=SC.Store.generateStoreKey(),n=SC.Record,o,p,q,r,s,t,u,v;!a&&!c&&!d&&(d=this.changelog),u=d?b(d,"length"):c?b(c,"length"):0;for(p=0;p<u;p++){d?q=d[p]:(h?o=a[p]||SC.Record:o=a,q=o.storeKeyFor(c[p])),v=i?f[p]:f,r=this.readStatus(q);if(r==n.EMPTY||r==n.ERROR)throw n.NOT_FOUND_ERROR;r==n.READY_NEW?(this.writeStatus(q,n.BUSY_CREATING),this.dataHashDidChange(q,m,YES),j.push(q),this._setCallbackForStoreKey(q,v,i,d)):r==n.READY_DIRTY?(this.writeStatus(q,n.BUSY_COMMITTING),this.dataHashDidChange(q,m,YES),k.push(q),this._setCallbackForStoreKey(q,v,i,d)):r==n.DESTROYED_DIRTY?(this.writeStatus(q,n.BUSY_DESTROYING),this.dataHashDidChange(q,m,YES),l.push(q),this._setCallbackForStoreKey(q,v,i,d)):r==n.DESTROYED_CLEAN&&this.dataHashDidChange(q,m,YES)}g&&(u>0||e)&&(t=g.commitRecords.call(g,this,j,k,l,e)),t&&!a&&!c&&(d===this.changelog?this.changelog=null:this.changelog.removeEach(d));return t},commitRecord:function(a,b,c,d,e){var f=this._TMP_RETRIEVE_ARRAY,g;if(b===undefined&&c===undefined)return NO;c!==undefined?(f[0]=c,c=f,b=null):(f[0]=b,b=f),g=this.commitRecords(a,b,c,d,e),f.length=0;return g},cancelRecords:function(a,b,c){var d=this._getDataSource(),e=SC.typeOf(a)==="array",f=SC.Record,g=[],h,i,j,k,l,m;i=c===undefined?b.length:c.length;for(j=0;j<i;j++){e?l=a[j]||SC.Record:l=a||SC.Record,k=b?b[j]:undefined,c===undefined?m=l.storeKeyFor(k):m=c?c[j]:undefined;if(m){h=this.readStatus(m);if(h==f.EMPTY||h==f.ERROR)throw f.NOT_FOUND_ERROR;g.push(m),this._cancelCallback(m)}}d&&d.cancel.call(d,this,g);return this},cancelRecord:function(a,b,c){var d=this._TMP_RETRIEVE_ARRAY,e;c!==undefined?(d[0]=c,c=d,b=null):(d[0]=b,b=d),e=this.cancelRecords(a,b,c),d.length=0;return this},loadRecord:function(a,c,d){var e=SC.Record,f,g,h;a=a||SC.Record,g=b(a,"proto").primaryKey,d=d||c[g],f=h=a.storeKeyFor(d),this.readStatus(h)&e.BUSY?this.dataSourceDidComplete(h,c,d):this.pushRetrieve(a,d,c,h);return f},loadRecords:function(a,c,d){var e=SC.typeOf(a)==="array",f=b(c,"length"),g=[],h=SC.Record,i,j,k,l,m,n;e||(i=a||SC.Record,k=b(i,"proto").primaryKey);for(l=0;l<f;l++)m=c.objectAt(l),e&&(i=a.objectAt(l)||SC.Record,k=b(i,"proto").primaryKey),j=d?d.objectAt(l):m[k],g[l]=this.loadRecord(i,m,j);return g},readError:function(a){var b=this.recordErrors;return b?b[a]:undefined},readQueryError:function(a){var b=this.queryErrors;return b?b[SC.guidFor(a)]:undefined},dataSourceDidCancel:function(a){var b=this.readStatus(a),c=SC.Record;if(!(b&c.BUSY))throw c.BAD_STATE_ERROR;switch(b){case c.BUSY_LOADING:b=c.EMPTY;break;case c.BUSY_CREATING:b=c.READY_NEW;break;case c.BUSY_COMMITTING:b=c.READY_DIRTY;break;case c.BUSY_REFRESH_CLEAN:b=c.READY_CLEAN;break;case c.BUSY_REFRESH_DIRTY:b=c.READY_DIRTY;break;case c.BUSY_DESTROYING:b=c.DESTROYED_DIRTY;break;default:throw c.BAD_STATE_ERROR}this.writeStatus(a,b),this.dataHashDidChange(a,null,YES),this._cancelCallback(a);return this},dataSourceDidComplete:function(a,b,c){var d=this.readStatus(a),f=SC.Record,g;if(!(d&f.BUSY))throw f.BAD_STATE_ERROR;if(d===f.BUSY_DESTROYING)throw f.BAD_STATE_ERROR;d=f.READY_CLEAN,this.writeStatus(a,d),b&&this.writeDataHash(a,b,d),c&&SC.Store.replaceIdFor(a,c),g=b||c?NO:YES,this.dataHashDidChange(a,null,g);var h=this.materializeRecord(a);e(h)||h.notifyPropertyChange("status"),this._retreiveCallbackForStoreKey(a);return this},dataSourceDidDestroy:function(a){var b=this.readStatus(a),c=SC.Record;if(!(b&c.BUSY))throw c.BAD_STATE_ERROR;b=c.DESTROYED_CLEAN,this.removeDataHash(a,b),this.dataHashDidChange(a);var d=this.materializeRecord(a);e(d)||d.notifyPropertyChange("status"),this._retreiveCallbackForStoreKey(a);return this},dataSourceDidError:function(a,b){var c=this.readStatus(a),d=this.recordErrors,f=SC.Record;if(!(c&f.BUSY))throw f.BAD_STATE_ERROR;c=f.ERROR,b&&b.isError&&(d||(d=this.recordErrors=[]),d[a]=b),this.writeStatus(a,c),this.dataHashDidChange(a,null,YES);var g=this.materializeRecord(a);e(g)||g.notifyPropertyChange("status"),this._retreiveCallbackForStoreKey(a);return this},pushRetrieve:function(a,b,c,d){var e=SC.Record,f;d===undefined&&(d=a.storeKeyFor(b)),f=this.readStatus(d);if(f==e.EMPTY||f==e.ERROR||f==e.READY_CLEAN||f==e.DESTROYED_CLEAN){f=e.READY_CLEAN,c===undefined?this.writeStatus(d,f):this.writeDataHash(d,c,f),this.dataHashDidChange(d);return d}return NO},pushDestroy:function(a,b,c){var d=SC.Record,e;c===undefined&&(c=a.storeKeyFor(b)),e=this.readStatus(c);if(e==d.EMPTY||e==d.ERROR||e==d.READY_CLEAN||e==d.DESTROYED_CLEAN){e=d.DESTROYED_CLEAN,this.removeDataHash(c,e),this.dataHashDidChange(c);return c}return NO},pushError:function(a,b,c,d){var e=SC.Record,f,g=this.recordErrors;d===undefined&&(d=a.storeKeyFor(b)),f=this.readStatus(d);if(f==e.EMPTY||f==e.ERROR||f==e.READY_CLEAN||f==e.DESTROYED_CLEAN){f=e.ERROR,c&&c.isError&&(g||(g=this.recordErrors=[]),g[d]=c),this.writeStatus(d,f),this.dataHashDidChange(d,null,YES);return d}return NO},loadQueryResults:function(a,d){if(b(a,"location")===SC.Query.LOCAL)throw new Error("Cannot load query results for a local query");var e=this._findQuery(a,YES,NO);e&&c(e,"storeKeys",d),this.dataSourceDidFetchQuery(a);return this},dataSourceDidFetchQuery:function(a){return this._scstore_dataSourceDidFetchQuery(a,YES)},_scstore_dataSourceDidFetchQuery:function(a,c){var d=this._findQuery(a,c,NO),e=b(this,"nestedStores"),f=e?b(e,"length"):0;d&&d.storeDidFetchQuery(a);while(--f>=0)e[f]._scstore_dataSourceDidFetchQuery(a,NO);return this},dataSourceDidCancelQuery:function(a){return this._scstore_dataSourceDidCancelQuery(a,YES)},_scstore_dataSourceDidCancelQuery:function(a,c){var d=this._findQuery(a,c,NO),e=b(this,"nestedStores"),f=e?b(e,"length"):0;d&&d.storeDidCancelQuery(a);while(--f>=0)e[f]._scstore_dataSourceDidCancelQuery(a,NO);return this},dataSourceDidErrorQuery:function(a,b){var c=this.queryErrors;b&&b.isError&&(c||(c=this.queryErrors={}),c[SC.guidFor(a)]=b);return this._scstore_dataSourceDidErrorQuery(a,YES)},_scstore_dataSourceDidErrorQuery:function(a,c){var d=this._findQuery(a,c,NO),e=b(this,"nestedStores"),f=e?b(e,"length"):0;d&&d.storeDidErrorQuery(a);while(--f>=0)e[f]._scstore_dataSourceDidErrorQuery(a,NO);return this},init:function(){this._super(),this.reset()},toString:function(){var a=b(this,"name");if(!a)return this._super();var c=this._super();return"%@ (%@)".fmt(a,c)},idFor:function(a){return SC.Store.idFor(a)},recordTypeFor:function(a){return SC.Store.recordTypeFor(a)},storeKeyFor:function(a,b){return a.storeKeyFor(b)},storeKeyExists:function(a,b){return a.storeKeyExists(b)},storeKeysFor:function(a){var b=[],c=a&&a.isEnumerable,d,e,f;if(!this.statuses)return b;for(e in SC.Store.recordTypesByStoreKey)d=SC.Store.recordTypesByStoreKey[e],c?f=a.contains(d):f=d===a,f&&this.statuses[e]&&b.push(parseInt(e,10));return b},storeKeys:function(){var a=[],b;if(!this.statuses)return a;for(b in this.statuses)this.statuses[b]!=SC.Record.EMPTY&&a.push(parseInt(b,10));return a},statusString:function(a){var b=this.materializeRecord(a);return b.statusString()}}),SC.Store.reopenClass({CHAIN_CONFLICT_ERROR:new Error("Nested Store Conflict"),NO_PARENT_STORE_ERROR:new Error("Parent Store Required"),NESTED_STORE_UNSUPPORTED_ERROR:new Error("Unsupported In Nested Store"),NESTED_STORE_RETRIEVE_DIRTY_ERROR:new Error("Cannot Retrieve Dirty Record in Nested Store"),EDITABLE:"editable",LOCKED:"locked",INHERITED:"inherited",idsByStoreKey:[],recordTypesByStoreKey:{},queriesByStoreKey:[],nextStoreKey:1,generateStoreKey:function(){return this.nextStoreKey++},idFor:function(a){return this.idsByStoreKey[a]},queryFor:function(a){return this.queriesByStoreKey[a]},recordTypeFor:function(a){return this.recordTypesByStoreKey[a]},replaceIdFor:function(a,b){var c=this.idsByStoreKey[a],d,e;if(c!==b){d=this.recordTypeFor(a);if(!d)throw new Error("replaceIdFor: storeKey %@ does not exist".fmt(a));this.idsByStoreKey[a]=b,e=d.storeKeysById(),delete e[c],e[b]=a}return this},replaceRecordTypeFor:function(a,b){this.recordTypesByStoreKey[a]=b;return this}}),SC.Store.reopen({nextStoreIndex:1}),SC.Store._getDefaultStore=function(){var a=this._store;a||(this._store=a=SC.Store.create());return a},SC.Store.updateRecords=function(a,b,c,d){SC.Logger.warn("SC.Store.updateRecords() is deprecated.  Use loadRecords() instead");var e=this._getDefaultStore(),f=a.length,g,h;if(!c){c=[];for(g=0;g<f;g++)c[g]=a[g].recordType}h=e.loadRecords(c,a),f=h.length;for(g=0;g<f;g++)h[g]=e.materializeRecord(h[g]);return h},SC.Store.find=function(a,b){return this._getDefaultStore().find(b,a)},SC.Store.findAll=function(a,b){return this._getDefaultStore().findAll(a,b)}}({}),function(a){var b=SC.get,c=SC.set,d=SC.platform.create;SC.NestedStore=SC.Store.extend({hasChanges:NO,parentStore:null,isNested:YES,lockOnRead:YES,locks:null,chainedChanges:null,find:function(a){sc_assert("SC.Store#find() can only accept LOCAL queries in nested stores",!a||!(a instanceof SC.Query)||b(a,"location")===SC.Query.LOCAL);return this._super.apply(this,arguments)},commitChanges:function(a){if(b(this,"hasChanges")){var c=b(this,"parentStore");c.commitChangesFromNestedStore(this,this.chainedChanges,a)}this.reset();return this},discardChanges:function(){var a,c;if((a=this.records)&&(c=this.locks)){var d=b(this,"parentStore"),e=d.revisions,f=this.revisions,g,h,i;for(g in a){if(!a.hasOwnProperty(g))continue;if(!(h=c[g]))continue;i=e[g],(i!==h||f[g]>i)&&this._notifyRecordPropertyChange(parseInt(g,10))}}this.reset(),this.flush();return this},destroy:function(){this.discardChanges();var a=b(this,"parentStore");a&&a.willDestroyNestedStore(this),this._super();return this},reset:function(){var a,e,f,g=b(this,"parentStore");if(!g)throw SC.Store.NO_PARENT_STORE_ERROR;this.dataHashes=d(g.dataHashes),this.revisions=d(g.revisions),this.statuses=d(g.statuses),this.childRecords=g.childRecords?d(g.childRecords):{},this.parentRecords=g.parentRecords?d(g.parentRecords):{},this.chainedChanges=this.locks=this.editables=null,this.changelog=null,c(this,"hasChanges",NO)},refreshQuery:function(a){var c=b(this,"parentStore");c&&c.refreshQuery(a);return this},readError:function(a){var c=b(this,"parentStore");return c?c.readError(a):null},readQueryError:function(a){var c=b(this,"parentStore");return c?c.readQueryError(a):null},storeKeyEditState:function(a){var b=this.editables,c=this.locks;return b&&b[a]?SC.Store.EDITABLE:c&&c[a]?SC.Store.LOCKED:SC.Store.INHERITED},_lock:function(a){var c=this.locks,d,e,f,g,h,i,j,k;if(c&&c[a])return this;c||(c=this.locks=[]),e=this.editables,e&&(e[a]=0);var l=b(this,"parentStore"),m;while(l&&(m=l.storeKeyEditState(a))===SC.Store.INHERITED)l=b(l,"parentStore");l&&m===SC.Store.EDITABLE?(f=this.childRecords[a],f?(this._lock(f),g=this.parentRecords[f],g&&(h=g[a],this.dataHashes[a]=h?SC.getPath(this.dataHashes[f],h):null)):this.dataHashes[a]=SC.copy(l.dataHashes[a],YES),e||(e=this.editables=[]),e[a]=1):this.dataHashes[a]=this.dataHashes[a],this.statuses[a]=this.statuses[a],d=this.revisions[a]=this.revisions[a],c[a]=d||1;return this},readDataHash:function(a){b(this,"lockOnRead")&&this._lock(a);return this.dataHashes[a]},readEditableDataHash:function(a){this._lock(a);return this._super(a)},writeDataHash:function(a,b,c){var d=this.locks,e=NO,f;b?this.dataHashes[a]=b:(this._lock(a),e=YES),c?this.statuses[a]=c:e||(this.statuses[a]=this.statuses[a]||SC.Record.READY_NEW),e||(f=this.revisions[a]=this.revisions[a],d||(d=this.locks=[]),d[a]||(d[a]=f||1));var g=this.editables;g||(g=this.editables=[]),g[a]=1;return this},removeDataHash:function(a,b){var c=this.locks;c||(c=this.locks=[]),c[a]||(c[a]=this.revisions[a]||1);return this._super(a,b)},dataHashDidChange:function(a,b,d,e){b||(b=SC.Store.generateStoreKey());var f,g,h,i;f=SC.typeOf(a)==="array",f?g=a.length:(g=1,i=a);var j=this.chainedChanges;j||(j=this.chainedChanges=SC.Set.create());for(h=0;h<g;h++)f&&(i=a[h]),this._lock(i),this.revisions[i]=b,j.add(i),this._notifyRecordPropertyChange(i,d,e);c(this,"hasChanges",YES);return this},commitChangesFromNestedStore:function(a,d,e){this._super(a,d,e);var f=b(this,"parentStore"),g=f.revisions,h,i=this.locks,j=this.chainedChanges,k,l;i||(i=this.locks=[]),j||(j=this.chainedChanges=SC.Set.create()),k=d.length;for(h=0;h<k;h++)l=d[h],i[l]||(i[l]=g[l]||1),j.add(l);c(this,"hasChanges",b(j,"length")>0),this.flush();return this},queryFor:function(a,c,d){return b(this,"parentStore").queryFor(a,c,d)},findAll:function(a,c,d,e,f){f||(f=this);return b(this,"parentStore").findAll(a,c,d,e,f)},retrieveRecords:function(a,c,d,e){var f=b(this,"parentStore"),g,h,i,j=d?d.length:c.length,k=SC.Record,l;if(e)for(g=0;g<j;g++){h=d?d[g]:f.storeKeyFor(a,c[g]),l=this.peekStatus(h);if(l&k.DIRTY)throw SC.Store.NESTED_STORE_RETRIEVE_DIRTY_ERROR;var m=this.dataHashes,n=this.revisions,o=this.statuses,p=this.editables,q=this.locks,r=NO,s=NO;m&&m.hasOwnProperty(h)&&(delete m[h],r=YES),n&&n.hasOwnProperty(h)&&(delete n[h],r=YES),p&&delete p[h],q&&delete q[h],o&&o.hasOwnProperty(h)&&(delete o[h],r||(s=YES),r=YES),r&&this._notifyRecordPropertyChange(h,s)}return f.retrieveRecords(a,c,d,e)},commitRecords:function(a,b,c){throw SC.Store.NESTED_STORE_UNSUPPORTED_ERROR},commitRecord:function(a,b,c){throw SC.Store.NESTED_STORE_UNSUPPORTED_ERROR},cancelRecords:function(a,b,c){throw SC.Store.NESTED_STORE_UNSUPPORTED_ERROR},cancelRecord:function(a,b,c){throw SC.Store.NESTED_STORE_UNSUPPORTED_ERROR},dataSourceDidCancel:function(a){throw SC.Store.NESTED_STORE_UNSUPPORTED_ERROR},dataSourceDidComplete:function(a,b,c){throw SC.Store.NESTED_STORE_UNSUPPORTED_ERROR},dataSourceDidDestroy:function(a){throw SC.Store.NESTED_STORE_UNSUPPORTED_ERROR},dataSourceDidError:function(a,b){throw SC.Store.NESTED_STORE_UNSUPPORTED_ERROR},pushRetrieve:function(a,b,c,d){throw SC.Store.NESTED_STORE_UNSUPPORTED_ERROR},pushDestroy:function(a,b,c){throw SC.Store.NESTED_STORE_UNSUPPORTED_ERROR},pushError:function(a,b,c,d){throw SC.Store.NESTED_STORE_UNSUPPORTED_ERROR}})}({}),function(a){}({}),function(a){}({})
